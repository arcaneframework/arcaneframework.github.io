<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Arcane: Utilisation des accélérateurs</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Arcane
   &#160;<span id="projectnumber">3.0.4.16</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Généré par Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Recherche','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Recherche');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('d2/dc8/arcanedoc_accelerator.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Utilisation des accélérateurs </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table des matières</h3>
<ul><li class="level1"><a href="#autotoc_md1">Utilisation dans Arcane</a></li>
<li class="level1"><a href="#autotoc_md2">Exemple d&#39;utilisation</a></li>
<li class="level1"><a href="#autotoc_md3">Compilation</a></li>
<li class="level1"><a href="#autotoc_md4">Exécution</a></li>
<li class="level1"><a href="#autotoc_md5">TODO</a></li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md__home_grospellierg_arcane_packaging_framework_arcane_doc_accelerator"></a></p>
<dl class="section warning"><dt>Avertissement</dt><dd>L'API d'utilisation des accélérateurs est en cours de développement et n'est pas figée. De plus il ne faut pas utiliser les classes autres que celles documentées dans cette page.</dd></dl>
<p>On appelle accélérateur un co-processeur dedié différent du processeur principal utilisé pour exécuté le code de calcul.</p>
<p>L'API Arcane pour gérer les accélérateurs s'inspire des bibliothèques telles que <a href="https://github.com/LLNL/RAJA">RAJA</a> ou <a href="https://github.com/kokkos/kokkos">Kokkos</a> mais se restreint aux besoins spécifiques de Arcane.</p>
<dl class="section note"><dt>Note</dt><dd>L'implémentation actuelle supporte uniquement comme accélérateur les cartes graphiques NVidia.</dd></dl>
<p>Le but de L'API est:</p>
<ul>
<li>pouvoir choisir dynamiquement où sera exécuté le code: CPU ou accélérateur (ou les deux à la fois)</li>
<li>avoir un code source indépendant du compilateur</li>
</ul>
<p>Le principe de fonctionnement est l'exécution de noyaux de calcul déportés. Le code est exécuté par défaut sur le CPU (l'hôte) et certains parties du calcul sont déportés sur les accélérateurs. Ce déport se fait via des appels spécifiques.</p>
<h1><a class="anchor" id="autotoc_md1"></a>
Utilisation dans Arcane</h1>
<p>L´ensemble des types utilisés pour la gestion des accélérateurs est dans l'espace de nom <a class="el" href="../../de/dae/namespaceArcane_1_1Accelerator.html" title="Espace de nom pour l&#39;utilisation des accélérateurs.">Arcane::Accelerator</a>. Les classes principales sont:</p>
<ul>
<li><a class="el" href="../../df/d02/classArcane_1_1Accelerator_1_1IAcceleratorMng.html" title="Interface du gestionnaire des accélérateurs.">Arcane::Accelerator::IAcceleratorMng</a> qui permet d'accéder à l'environnement d'exécution par défaut.</li>
<li><a class="el" href="../../d1/d61/classArcane_1_1Accelerator_1_1Runner.html" title="Gestionnaire d&#39;exécution pour accélérateur.">Arcane::Accelerator::Runner</a> qui représente un environnement d'exécution</li>
<li><a class="el" href="../../d9/d8e/classArcane_1_1Accelerator_1_1RunQueue.html" title="File d&#39;exécution pour accélérateur.">Arcane::Accelerator::RunQueue</a> qui représente une file d'exécution</li>
<li><a class="el" href="../../dd/d65/classArcane_1_1Accelerator_1_1RunCommand.html" title="Gestion d&#39;une commande sur accélérateur.">Arcane::Accelerator::RunCommand</a> qui représente une commande (un noyau de calcul) associée à une file d'exécution.</li>
</ul>
<p>L'interface principale est <a class="el" href="../../df/d02/classArcane_1_1Accelerator_1_1IAcceleratorMng.html" title="Interface du gestionnaire des accélérateurs.">Arcane::Accelerator::IAcceleratorMng</a>. Une implémentation de cette interface est créé lors de l'initialisation et est disponible pour les modules via la méthode <a class="el" href="../../dd/dde/classArcane_1_1AbstractModule.html#a312edb9ebe8dc3e177e060d61ceb83f9" title="Gestionnaire des accélérateurs.">Arcane::AbstractModule::acceleratorMng()</a>.</p>
<p>L'objet principal est la classe <a class="el" href="../../d1/d61/classArcane_1_1Accelerator_1_1Runner.html" title="Gestionnaire d&#39;exécution pour accélérateur.">Arcane::Accelerator::Runner</a>. Il est possible de créér plusieurs instances de cet objet.</p>
<dl class="section note"><dt>Note</dt><dd>Actuellement, les méthodes de <a class="el" href="../../d1/d61/classArcane_1_1Accelerator_1_1Runner.html" title="Gestionnaire d&#39;exécution pour accélérateur.">Arcane::Accelerator::Runner</a> ne sont pas thread-safe.</dd></dl>
<p>Une instance de cette classe est associée à une politique d'exécution dont les valeurs possibles sont données par l'énumération <a class="el" href="../../de/dae/namespaceArcane_1_1Accelerator.html#acfc7ad484093ab4477c65b4c833857df" title="Politique d&#39;exécution.">Arcane::Accelerator::eExecutionPolicy</a>. Par défaut, la politique d'exécution est <a class="el" href="../../de/dae/namespaceArcane_1_1Accelerator.html#acfc7ad484093ab4477c65b4c833857dfaa7e82daa7280af25afbaa076ac16eb1e" title="Politique d&#39;exécution séquentielle.">Arcane::Accelerator::eExecutionPolicy::Sequential</a>, ce qui signifie que les noyaux de calcul seront exécutés en séquentiel.</p>
<p>Il est aussi possible d'initialiser automatiquement une instance de cette classe en fonction des arguments de la ligne de commande:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;arcane/accelerator/RunQueue.h&quot;</span></div>
<div class="line"><span class="keyword">using namespace </span><a class="code" href="../../d0/d32/namespaceArcane.html">Arcane</a>;</div>
<div class="line"><span class="keyword">using namespace </span><a class="code" href="../../de/dae/namespaceArcane_1_1Accelerator.html">Arcane::Accelerator</a>;</div>
<div class="line">Runner runner;</div>
<div class="line">ITraceMng* tm = ...;</div>
<div class="line">IApplication* app = ...;</div>
<div class="line"><a class="code" href="../../de/dae/namespaceArcane_1_1Accelerator.html#a7789984675f78ee98fec466129a9d6cf">initializeRunner</a>(runner,tm,app-&gt;acceleratorRuntimeInitialisationInfo());</div>
<div class="ttc" id="anamespaceArcane_1_1Accelerator_html"><div class="ttname"><a href="../../de/dae/namespaceArcane_1_1Accelerator.html">Arcane::Accelerator</a></div><div class="ttdoc">Espace de nom pour l'utilisation des accélérateurs.</div><div class="ttdef"><b>Definition:</b> ArcaneTypes.h:474</div></div>
<div class="ttc" id="anamespaceArcane_1_1Accelerator_html_a7789984675f78ee98fec466129a9d6cf"><div class="ttname"><a href="../../de/dae/namespaceArcane_1_1Accelerator.html#a7789984675f78ee98fec466129a9d6cf">Arcane::Accelerator::initializeRunner</a></div><div class="ttdeci">ARCANE_ACCELERATOR_EXPORT void initializeRunner(Runner &amp;runner, ITraceMng *tm, const AcceleratorRuntimeInitialisationInfo &amp;acc_info)</div><div class="ttdoc">Initialise runner en fonction de la valeur de acc_info.</div><div class="ttdef"><b>Definition:</b> Accelerator.cc:24</div></div>
<div class="ttc" id="anamespaceArcane_html"><div class="ttname"><a href="../../d0/d32/namespaceArcane.html">Arcane</a></div><div class="ttdoc">Interface for base mesh operations.</div><div class="ttdef"><b>Definition:</b> AbstractCaseDocumentVisitor.cc:20</div></div>
</div><!-- fragment --><p>Pour lancer un calcul sur accélérateur, il faut instancier une file d'exécution. La classe <a class="el" href="../../d9/d8e/classArcane_1_1Accelerator_1_1RunQueue.html" title="File d&#39;exécution pour accélérateur.">Arcane::Accelerator::RunQueue</a> gère une telle file. La fonction <a class="el" href="../../de/dae/namespaceArcane_1_1Accelerator.html#a03c277b9b5cda10acc53f493d26ef2e2" title="Créé une file temporaire associée à runner.">Arcane::Accelerator::makeQueue()</a> permet de créer une telle file. Les files d'exécution peuvent être temporaires ou persistantes mais ne peuvent pas être copiées. La méthode <a class="el" href="../../de/dae/namespaceArcane_1_1Accelerator.html#a663ef59ff7abfd160c0e4f146b8f1026" title="Créé une référence sur file avec la politique d&#39;exécution par défaut de runner.">Arcane::Accelerator::makeQueueRef()</a> permet de créer une référence à une file qui peut être copiée.</p>
<h1><a class="anchor" id="autotoc_md2"></a>
Exemple d'utilisation</h1>
<div class="fragment"><div class="line"><span class="keyword">using namespace </span><a class="code" href="../../d0/d32/namespaceArcane.html">Arcane</a>;</div>
<div class="line"><span class="keyword">using namespace </span><a class="code" href="../../de/dae/namespaceArcane_1_1Accelerator.html">Arcane::Accelerator</a>;</div>
<div class="line">{</div>
<div class="line">  Runner runner = ...;</div>
<div class="line">  <span class="keyword">auto</span> queue = <a class="code" href="../../de/dae/namespaceArcane_1_1Accelerator.html#a03c277b9b5cda10acc53f493d26ef2e2">makeQueue</a>(runner);</div>
<div class="line">  <span class="keyword">auto</span> command = <a class="code" href="../../de/dae/namespaceArcane_1_1Accelerator.html#af725069ceba4d3878d643f0aa9ee9dd6">makeCommand</a>(queue);</div>
<div class="line">  <span class="keyword">auto</span> out_t1 = <a class="code" href="../../de/dae/namespaceArcane_1_1Accelerator.html#a86ace38caaddebf21d77cf886ed1d509">viewOut</a>(command,t1);</div>
<div class="line">  Int64 base = 300;</div>
<div class="line">  Int64 s1 = 400;</div>
<div class="line">  <span class="keyword">auto</span> b = <a class="code" href="../../d0/d32/namespaceArcane.html#aabbd3bd1d0aa011a301a55fb36018915">makeLoopRanges</a>({base,s1},n2,n3,n4);</div>
<div class="line">  command &lt;&lt; <a class="code" href="../../d6/d52/RunCommandLoop_8h.html#ab7e14f7438197160df439871b0108540">RUNCOMMAND_LOOP</a>(iter,b)</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">auto</span> [i, j, k, l] = iter();</div>
<div class="line">    out_t1(i,j,k,l) = _getValue(i,j,k,l);</div>
<div class="line">  };</div>
<div class="line">}</div>
<div class="ttc" id="aRunCommandLoop_8h_html_ab7e14f7438197160df439871b0108540"><div class="ttname"><a href="../../d6/d52/RunCommandLoop_8h.html#ab7e14f7438197160df439871b0108540">RUNCOMMAND_LOOP</a></div><div class="ttdeci">#define RUNCOMMAND_LOOP(iter_name, bounds)</div><div class="ttdoc">Boucle sur accélérateur.</div><div class="ttdef"><b>Definition:</b> RunCommandLoop.h:167</div></div>
<div class="ttc" id="anamespaceArcane_1_1Accelerator_html_a03c277b9b5cda10acc53f493d26ef2e2"><div class="ttname"><a href="../../de/dae/namespaceArcane_1_1Accelerator.html#a03c277b9b5cda10acc53f493d26ef2e2">Arcane::Accelerator::makeQueue</a></div><div class="ttdeci">RunQueue makeQueue(Runner &amp;runner)</div><div class="ttdoc">Créé une file temporaire associée à runner.</div><div class="ttdef"><b>Definition:</b> Runner.h:60</div></div>
<div class="ttc" id="anamespaceArcane_1_1Accelerator_html_a86ace38caaddebf21d77cf886ed1d509"><div class="ttname"><a href="../../de/dae/namespaceArcane_1_1Accelerator.html#a86ace38caaddebf21d77cf886ed1d509">Arcane::Accelerator::viewOut</a></div><div class="ttdeci">auto viewOut(RunCommand &amp;command, NumArray&lt; DataType, N &gt; &amp;var)</div><div class="ttdoc">Vue en écriture.</div><div class="ttdef"><b>Definition:</b> NumArrayViews.h:200</div></div>
<div class="ttc" id="anamespaceArcane_1_1Accelerator_html_af725069ceba4d3878d643f0aa9ee9dd6"><div class="ttname"><a href="../../de/dae/namespaceArcane_1_1Accelerator.html#af725069ceba4d3878d643f0aa9ee9dd6">Arcane::Accelerator::makeCommand</a></div><div class="ttdeci">RunCommand makeCommand(RunQueue &amp;run_queue)</div><div class="ttdoc">Créé une commande associée à la file run_queue.</div><div class="ttdef"><b>Definition:</b> RunQueue.h:66</div></div>
<div class="ttc" id="anamespaceArcane_html_aabbd3bd1d0aa011a301a55fb36018915"><div class="ttname"><a href="../../d0/d32/namespaceArcane.html#aabbd3bd1d0aa011a301a55fb36018915">Arcane::makeLoopRanges</a></div><div class="ttdeci">SimpleLoopRanges&lt; 1 &gt; makeLoopRanges(Int64 n1)</div><div class="ttdoc">Créé un intervalle d'itération [0,n1[.</div><div class="ttdef"><b>Definition:</b> LoopRanges.h:113</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md3"></a>
Compilation</h1>
<p>Pour pouvoir utiliser des noyaux de calcul sur accélérateur, il faut en général utiliser un compilateur spécifique. L'implémentation actuelle de Arcane via CUDA utilise le compilateur <code>nvcc</code> de NVIDIA pour cela. Ce compilateur se charge de compiler la partie associée à l'accélérateur. La partie associée au CPU est compilée avec le même compilateur que le reste du code.</p>
<p>Il est nécessaire de spécifier dans le <code>CMakeLists.txt</code> qu'on souhaite utiliser les accélérateurs ainsi que les fichiers qui seront compilés pour les accélérateurs. Seuls les fichiers utilisant des commandes (RUNCOMMAND_LOOP ou RUNCOMMAND_ENUMERATE) ont besoin d'être compilés pour les accélérateurs. Pour cela, Arcane définit les fonctions CMake suivantes:</p>
<ul>
<li><b>arcane_accelerator_enable()</b> qui doit être appeler vant les autres fonctions pour détecter l'environnement de compilation pour accélérateur</li>
<li><b>arcane_accelerator_add_source_files(file1.cc [file2.cc] ...)</b> pour indiquer les fichiers sources qui doivent être compilés sur accélérateurs</li>
<li><b>arcane_accelerator_add_to_target(mytarget)</b> pour indiquer que la cible <code>mytarget</code> a besoin de l'environnement accélérateur.</li>
</ul>
<p>Si Arcane est compilé en environnement CUDA, la variable CMake <code>ARCANE_HAS_CUDA</code> est définie.</p>
<h1><a class="anchor" id="autotoc_md4"></a>
Exécution</h1>
<p>Le choix de l'environnement d'exécution par défaut (<a class="el" href="../../df/d02/classArcane_1_1Accelerator_1_1IAcceleratorMng.html#a741e717bf5c83f74bdad33387c2702d0" title="Exécuteur par défaut.">Arcane::Accelerator::IAcceleratorMng::defaultRunner()</a>) est déterminé par la ligne de commande:</p>
<ul>
<li>Si l'option <code>AcceleratorRuntime</code> est spécifiée, on utilise ce runtime. Actuellement la seule valeur possible est <code>cuda</code>. Par exemple: <div class="fragment"><div class="line">MyExec -A,AcceleratorRuntime=cuda data.arc</div>
</div><!-- fragment --></li>
<li>Sinon, si le multi-threading est activé via l'option <code>-T</code> (voir <a class="el" href="../../da/da4/arcanedoc_launcher.html">Lancement d'un calcul</a>), alors les noyaux de calcul sont répartis sur plusieurs threads,</li>
<li>Sinon, les noyaux de calcul sont exécutés en séquentiel.</li>
</ul>
<h1><a class="anchor" id="autotoc_md5"></a>
TODO</h1>
<p>TODO: expliquer la capture des lambda avec le 'this'</p>
<p>TODO: expliquer mémoire unifiée ne pas utiliser le CPU en même temps que le GPU</p>
<p>TODO: expliquer utilisation des NumArray.</p>
<p>TODO: expliquer utilisation des vues </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../index.html">%Arcane</a></li>
    <li class="footer">Généré le Jeudi 23 Septembre 2021 09:25:20 pour Arcane par <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
