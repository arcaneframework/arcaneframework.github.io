<!-- HTML header for doxygen 1.9.5-->
<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=11" />
    <meta name="generator" content="Doxygen 1.9.8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Arcane: Gestion des matériaux et des milieux.</title>
    <link href="../../tabs.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="../../jquery.js"></script>
    <script type="text/javascript" src="../../dynsections.js"></script>
    <link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
    <link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript">
window.MathJax = {
  options: {
    ignoreHtmlClass: 'tex2jax_ignore',
    processHtmlClass: 'tex2jax_process'
  }
};
</script>
<script type="text/javascript" id="MathJax-script" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    <link href="../../doxygen.css" rel="stylesheet" type="text/css" />
    <link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-custom.css" rel="stylesheet" type="text/css"/>
<link href="../../custom.css" rel="stylesheet" type="text/css"/>
<link href="../../user_colors.css" rel="stylesheet" type="text/css"/>
    <script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
    <script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
    <script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
    <script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
    <script type="text/javascript" src="../../doxygen-awesome-tabs.js"></script>
    <script type="text/javascript" src="../../script-helper.js"></script>
    <script type="text/javascript" src="../../script-resize.js"></script>
    <script type="text/javascript" src="../../script-num-lines-code.js"></script>
    <script type="text/javascript" src="../../script-config-theme.js"></script>
    <script type="text/javascript" src="../../script-edit-config-theme.js"></script>
    <script type="text/javascript" src="../../script-alternative-theme.js"></script>
    <script type="text/javascript">
      // On demande l'activation de la personnalisation de la page.
      var no_custom_theme = false;
      DoxygenAwesomeDarkModeToggle.title = "Thème clair/sombre";
      DoxygenAwesomeDarkModeToggle.init();
      DoxygenAwesomeFragmentCopyButton.title = "Copier le code dans le presse-papier";
      DoxygenAwesomeFragmentCopyButton.init();
      DoxygenAwesomeParagraphLink.init();
      DoxygenAwesomeInteractiveToc.init();
      DoxygenAwesomeTabs.init()
      waitElemForResizeSideNav();
      setOldSize();
      //waitItemExpandCurrent();
    </script>
  </head>
  <body>
    <!--BEGIN CORNER_GITHUB-->
    <!-- https://tholman.com/github-corners/ -->
    <a href="https://github.com/arcaneframework/framework" class="github-corner" aria-label="Voir les sources sur GitHub">
      <svg width="70" height="70" viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path
          d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
          fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path
          d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
          fill="currentColor" class="octo-body"></path>
      </svg>
    </a>
    <!--END CORNER_GITHUB-->
      <div id="top">
        <!-- do not remove this div, it is closed by doxygen! -->
        <div id="titlearea">
          <table cellspacing="0" cellpadding="0">
            <tbody>
              <tr id="projectrow">
                <td id="projectlogo">
                  <a href="../../index.html" title="Aller à la page principale">
                    <img alt="Logo" src="../../arcane_logo.webp" />
                  </a>
                </td>
              </tr>
              <tr id="projectrow">
                <td id="projectalign">
                  <div id="projectname">Arcane
                    <span id="projectnumber">&#160;v3.12.18.0</span>
                  </div>
                  <div id="projectbrief">Documentation utilisateur</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- end header part --><!-- Généré par Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Recherche');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('de/d9b/arcanedoc_materials_manage.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Chargement...</div>
<div class="SRStatus" id="Searching">Recherche...</div>
<div class="SRStatus" id="NoMatches">Aucune correspondance</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Gestion des matériaux et des milieux.</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table des matières</h3>
<ul><li class="level1"><a href="#arcanedoc_materials_manage_create">Création des matériaux, des milieux et des blocs</a></li>
<li class="level1"><a href="#arcanedoc_materials_manage_addremovecells">Ajout ou suppression de mailles d&#39;un matériau</a></li>
<li class="level1"><a href="#arcanedoc_materials_manage_iteration">Itération sur les mailles matériaux</a></li>
<li class="level1"><a href="#arcanedoc_materials_manage_conversion">Conversion Cell vers AllEnvCell, MatCell ou EnvCell</a></li>
<li class="level1"><a href="#arcanedoc_materials_manage_component">Unification</a></li>
<li class="level1"><a href="#arcanedoc_materials_manage_variable">Variables matériaux</a><ul><li class="level2"><a href="#arcanedoc_materials_manage_variable_build">Construction</a></li>
<li class="level2"><a href="#arcanedoc_materials_manage_variable_usage">Utilisation</a></li>
<li class="level2"><a href="#arcanedoc_materials_manage_variable_synchronize">Synchronisations</a></li>
<li class="level2"><a href="#arcanedoc_materials_manage_variable_dependencies">Gestion des dépendances</a></li>
</ul>
</li>
<li class="level1"><a href="#arcanedoc_materials_manage_environment_variable">Variables milieux</a></li>
<li class="level1"><a href="#arcanedoc_materials_manage_concurrency">Parallélisation des boucles sur les matériaux et milieux</a></li>
<li class="level1"><a href="#arcanedoc_materials_manage_optimization">Optimisation des modifications sur les matériaux et les milieux.</a><ul><li class="level2"><a href="#arcanedoc_materials_manage_optimization_implementation">Notes sur l&#39;implémentation</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p>Cette page décrit la gestion des matériaux et des milieux dans Arcane.</p>
<p>L'ensemble des classes associées aux matériaux et milieux se trouvent dans le namespace <a class="el" href="../../d5/d4d/namespaceMaterials.html" title="Ensemble des classes assurant la gestion des matériaux et des milieux.">Materials</a> de <a class="el" href="../../d0/d32/namespaceArcane.html" title="-*- tab-width: 2; indent-tabs-mode: nil; coding: utf-8-with-signature -*-">Arcane</a> (voir <a class="el" href="../../d9/d01/group__ArcaneMaterials.html">Matériaux et des milieux.</a>). Le plus simple pour utiliser ces classes est d'utiliser le mot clé <em>using</em>. Par exemple :</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;arcane/materials/IMeshMaterial.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">using namespace </span><a class="code hl_namespace" href="../../d4/d60/namespaceArcane_1_1Materials.html">Arcane::Materials</a>;</div>
<div class="ttc" id="anamespaceArcane_1_1Materials_html"><div class="ttname"><a href="../../d4/d60/namespaceArcane_1_1Materials.html">Arcane::Materials</a></div><div class="ttdoc">Active toujours les traces dans les parties Arcane concernant les matériaux.</div><div class="ttdef"><b>Definition</b> <a href="../../de/de8/ItemCompatibility_8h_source.html#l00026">ItemCompatibility.h:27</a></div></div>
</div><!-- fragment --><p>L'ensemble des milieux et des matériaux est gérée par la classe IMeshMaterialMng. Une instance de cette classe est associée à un maillage IMesh. Il est possible d'avoir plusieurs instances de IMeshMaterialMng par IMesh mais cela n'est pas utilisé pour l'instant.</p>
<dl class="section warning"><dt>Avertissement</dt><dd>Pour l'instant, la gestion des matériaux et milieux est incompatible avec les modifications de la topologie de maillage. En particulier, cela inclue le repartionnement dû à l'équilibrage de charge.</dd></dl>
<dl class="section note"><dt>Note</dt><dd>A partir de la version 1.20.2, il est possible de modifier partiellement la topologie du maillage. Néanmoins, il s'agit uniquement d'un mode de test, sans garantie sur les résultats. De plus, il faut respecter les contraintes suivantes :<ul>
<li>appeler IMeshMaterialMng::setMeshModificationNotified(true) avant de créer les milieux et matériaux.</li>
<li>uniquement en mode séquentiel</li>
<li>uniquement en supprimant des mailles.</li>
</ul>
</dd></dl>
<p>Une instance de IMeshMaterialMng décrit un ensemble de milieux, chaque milieu étant composé d'un ou plusieurs matériaux. La liste des milieux et des matériaux doit aussi être créé lors de l'initialisation du calcul et ne plus évoluer par la suite. Il est aussi possible d'avoir la notion de bloc au-dessus de la motion de milieu, un bloc comprenant un ou plusieurs milieux. Cette notion de bloc est optionnel et n'est pas indispensable à l'utilisation des milieux ou des matériaux</p>
<p>Dans l'implémentation actuelle, les milieux et les matériaux ne sont associées qu'aux mailles et pas aux autres entités du maillage. La liste des mailles d'un milieu ou d'un matériau est dynamique et peut évoluer au cours du calcul. De même, il est possible d'avoir plusieurs milieux et plusieurs matériaux par maille.</p>
<dl class="section note"><dt>Note</dt><dd>Il ne faut pas détruire manuellement les instances de IMeshMaterialMng. Elles seront automatiquement détruites lorsque le maillage associé sera supprimé.</dd></dl>
<p>L'instance par défaut de IMeshMaterialMng pour un maillage ne se créée pas directement. Pour la récupérer, il faut utiliser la méthode IMeshMaterialMng::getReference() avec comme argument le maillage concerné. L'appel à cette fonction provoque la création du gestionnaire si ce n'est pas déjà fait. Cette fonction à un coût CPU non négligeable et il est donc préférable de stocker l'instance retournée plutôt que d'appeler la fonction plusieurs fois.</p>
<div class="fragment"><div class="line">    <span class="comment">// Création ou récupération du gestionnaire depuis un maillage.</span></div>
<div class="line">    IMeshMaterialMng* material_mng = IMeshMaterialMng::getReference(defaultMesh());</div>
</div><!-- fragment --><h1><a class="anchor" id="arcanedoc_materials_manage_create"></a>
Création des matériaux, des milieux et des blocs</h1>
<p>Une fois le gestionnaire créé, il faut enregistrer les matériaux et les milieux. La première chose à faire est d'enregistrer les caractéristiques des matériaux. Pour l'instant, il s'agit uniquement du nom du matériau. On enregistre uniquement les caractéristiques des matériaux et pas les matériaux eux-mêmes car ces derniers sont créés lors de la création des milieux.</p>
<div class="fragment"><div class="line">    <span class="comment">// Exemple de création de 3 matériaux:</span></div>
<div class="line">    material_mng-&gt;registerMaterialInfo(<span class="stringliteral">&quot;MAT1&quot;</span>);</div>
<div class="line">    material_mng-&gt;registerMaterialInfo(<span class="stringliteral">&quot;MAT2&quot;</span>);</div>
<div class="line">    material_mng-&gt;registerMaterialInfo(<span class="stringliteral">&quot;MAT3&quot;</span>);</div>
</div><!-- fragment --><p>Une fois les caractéristiques enregistrées, il est possible de créer les milieux, en spécifiant leur nom et la liste de leurs matériaux. Il faut noter que deux milieux (ou plus) peuvent être constitués du même matériau. Dans ce cas, <a class="el" href="../../d0/d32/namespaceArcane.html" title="-*- tab-width: 2; indent-tabs-mode: nil; coding: utf-8-with-signature -*-">Arcane</a> créé deux instances différentes du même matériau et ces dernières sont indépendantes. Ainsi, dans l'exemple suivant, le matériau MAT1 est présent dans ENV1 et ENV3, ce qui fait deux matériaux distincts avec chacun leurs valeurs partielles. Une fois les milieux créés, il est possible de les associés dans des blocs. Un bloc est défini par un nom, le groupe de maille associé et sa liste des milieux, qui est donc fixe.</p>
<div class="fragment"><div class="line">    <span class="comment">// Création du milieu ENV1 contenant les matériaux MAT1 et MAT2</span></div>
<div class="line">    MeshEnvironmentBuildInfo ebi1(<span class="stringliteral">&quot;ENV1&quot;</span>);</div>
<div class="line">    ebi1.addMaterial(<span class="stringliteral">&quot;MAT1&quot;</span>);</div>
<div class="line">    ebi1.addMaterial(<span class="stringliteral">&quot;MAT2&quot;</span>);</div>
<div class="line">    IMeshEnvironment* env1 = material_mng-&gt;createEnvironment(ebi1);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Création du milieu ENV2 contenant le matériau MAT2</span></div>
<div class="line">    MeshEnvironmentBuildInfo ebi2(<span class="stringliteral">&quot;ENV2&quot;</span>);</div>
<div class="line">    ebi2.addMaterial(<span class="stringliteral">&quot;MAT2&quot;</span>);</div>
<div class="line">    IMeshEnvironment* env2 = material_mng-&gt;createEnvironment(ebi2);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Création du milieu ENV3 contenant les matériaux MAT3 et MAT1</span></div>
<div class="line">    MeshEnvironmentBuildInfo ebi3(<span class="stringliteral">&quot;ENV3&quot;</span>);</div>
<div class="line">    ebi3.addMaterial(<span class="stringliteral">&quot;MAT3&quot;</span>);</div>
<div class="line">    ebi3.addMaterial(<span class="stringliteral">&quot;MAT1&quot;</span>);</div>
<div class="line">    IMeshEnvironment* env3 = material_mng-&gt;createEnvironment(ebi3);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Création du bloc BLOCK1 sur le groupe de toutes les mailles</span></div>
<div class="line">    <span class="comment">// et contenant les milieux ENV1 et ENV2</span></div>
<div class="line">    MeshBlockBuildInfo mb1(<span class="stringliteral">&quot;BLOCK1&quot;</span>,allCells());</div>
<div class="line">    mb1.addEnvironment(env1);</div>
<div class="line">    mb1.addEnvironment(env2);</div>
<div class="line">    IMeshBlock* block = material_mng-&gt;createBlock(mb1);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Indique au gestionnaire que l&#39;initialisation est terminée</span></div>
<div class="line">    material_mng-&gt;endCreate();</div>
</div><!-- fragment --><p>Une fois tous les milieux et blocs créés, il faut appeler IMeshMaterialMng::endCreate() pour signaler au gestionnaire que l'initialisation est terminée et qu'il peut allouer les variables. Une fois cette méthode appelée, il ne faut plus créer de blocs, ni de milieux ni de matériaux.</p>
<dl class="section note"><dt>Note</dt><dd>Depuis la version 2.3.3 de Arcane, il est possible d'ajouter des milieux à un bloc entre sa création (IMeshMaterialMng::createBlock()) et l'appel à IMeshMaterialMng::endCreate(), via la méthode IMeshMaterialMng::addEnvironmentToBlock().</dd>
<dd>
Depuis la version 2.3.4 de Arcane, il est possible de supprimer des milieux à un bloc entre sa création (IMeshMaterialMng::createBlock()) et l'appel à IMeshMaterialMng::endCreate(), via la méthode IMeshMaterialMng::removeEnvironmentToBlock().</dd></dl>
<p>Les instances de IMeshMaterial, IMeshEnvironment et IMeshBlock restent valident durant toute l'existence du IMeshMaterialMng correspondant. Elles peuvent donc être conservées et il est possible d'utiliser l'opérateur d'égalité pour savoir si deux instances correspondent au même matériau.</p>
<dl class="section note"><dt>Note</dt><dd>A partir de la version 1.21.1, les informations concernant les blocs, les matériaux et les milieux sont sauvegardées et peuvent être relues en reprise. Néanmoins, cela n'est pas automatique pour des raisons de compatibilité. Si on souhaite relire les informations sauvegardées, il faut appeler IMeshMaterialMng::recreateFromDump() et ne plus créér manuellement les informations ni appeler la méthode IMeshMaterialMng::endCreate().</dd></dl>
<p>Chaque matériau IMeshMaterial, milieu IMeshEnvironment et bloc IMeshBlock possède un identifiant unique, de type Int32, qui est accessible via les méthodes IMeshMaterial::id(), IMeshEnvironment::id() ou IMeshBlock::id(). Ces identifiants commencent à 0 et sont incrémentés pour chaque matériau, milieu ou bloc. Par exemple, avec la construction de l'exemple précédent, on a :</p>
<div class="fragment"><div class="line">    info() &lt;&lt; env1-&gt;id();                 <span class="comment">// Affiche &#39;0&#39;</span></div>
<div class="line">    info() &lt;&lt; env1-&gt;materials()[0]-&gt;id(); <span class="comment">// Affiche &#39;0&#39;</span></div>
<div class="line">    info() &lt;&lt; env1-&gt;materials()[1]-&gt;id(); <span class="comment">// Affiche &#39;1&#39;</span></div>
<div class="line">    info() &lt;&lt; env2-&gt;id();                 <span class="comment">// Affiche &#39;1&#39;</span></div>
<div class="line">    info() &lt;&lt; env2-&gt;materials()[0]-&gt;id(); <span class="comment">// Affiche &#39;2&#39;</span></div>
<div class="line">    info() &lt;&lt; env3-&gt;id();                 <span class="comment">// Affiche &#39;2&#39;</span></div>
<div class="line">    info() &lt;&lt; env3-&gt;materials()[0]-&gt;id(); <span class="comment">// Affiche &#39;3&#39;</span></div>
<div class="line">    info() &lt;&lt; env3-&gt;materials()[1]-&gt;id(); <span class="comment">// Affiche &#39;4&#39;</span></div>
<div class="line">    info() &lt;&lt; block-&gt;id();                <span class="comment">// Affiche &#39;0&#39;</span></div>
</div><!-- fragment --><h1><a class="anchor" id="arcanedoc_materials_manage_addremovecells"></a>
Ajout ou suppression de mailles d'un matériau</h1>
<p>Une fois les matériaux et milieux créés, il est possible d'ajouter ou de supprimer des mailles pour un matériau. Il n'est pas nécessaire de modifier les mailles par milieu : <a class="el" href="../../d0/d32/namespaceArcane.html" title="-*- tab-width: 2; indent-tabs-mode: nil; coding: utf-8-with-signature -*-">Arcane</a> se charge de recalculer automatiquement la liste des mailles d'un milieu en fonction de celles de ses matériaux.</p>
<p>Toute modification se fait via la classe MeshMaterialModifier. Il suffit de créer une instance de cette classe et d'appeler autant de fois que nécessaire les méthodes MeshMaterialModifier::addCells() ou MeshMaterialModifier::removeCells(). Il faut noter que ceux deux méthodes permettent uniquement d'indiquer les mailles à ajouter ou supprimer. La modification effective n'a lieu que lors de l'appel à MeshMaterialModifier::endUpdate() ou de la destruction l'instance de MeshMaterialModifier. C'est seulement à ce moment là que les valeurs partielles sont mises à jour et qu'il est possible d'y accéder.</p>
<dl class="section note"><dt>Note</dt><dd>Pour l'instant, les variables partielles des matériaux sont automatiquement initialisées à 0 dans les nouvelles mailles d'un matériau. Pour des raisons de performance, il est possible que cela ne soit plus le cas et alors les valeurs ne seront pas initialisées.</dd></dl>
<div class="fragment"><div class="line">    {</div>
<div class="line">      <span class="comment">// Créé l&#39;instance de modification. Les modifications</span></div>
<div class="line">      <span class="comment">// seront effectives lors de l&#39;appel au destructeur de</span></div>
<div class="line">      <span class="comment">// cette classe.</span></div>
<div class="line">      MeshMaterialModifier modifier(material_mng);</div>
<div class="line">      <span class="comment">// Ajoute les mailles du matériau 1 ou 2 en fonction</span></div>
<div class="line">      <span class="comment">// de leur localId()</span></div>
<div class="line">      Int32UniqueArray mat1_indexes;</div>
<div class="line">      Int32UniqueArray mat2_indexes;</div>
<div class="line">      Integer nb_cell = allCells().size();</div>
<div class="line">      <a class="code hl_define" href="../../d6/d0f/ItemEnumerator_8h.html#aaf5910d68ad8428248f844535ab071f3">ENUMERATE_CELL</a>(icell,allCells()){</div>
<div class="line">        Int32 local_id = icell.itemLocalId();</div>
<div class="line">        Integer z = icell.index();</div>
<div class="line">        <span class="keywordtype">bool</span> add_to_mat1 = (z&lt;(nb_cell/2) &amp;&amp; z&gt;(nb_cell/4));</div>
<div class="line">        <span class="keywordtype">bool</span> add_to_mat2 = (z&gt;=(nb_cell/2) || z&lt;(nb_cell/3));</div>
<div class="line">        <span class="keywordflow">if</span> (add_to_mat1)</div>
<div class="line">          mat1_indexes.add(local_id);</div>
<div class="line">        <span class="keywordflow">if</span> (add_to_mat2)</div>
<div class="line">          mat2_indexes.add(local_id);</div>
<div class="line">      }</div>
<div class="line">      <span class="comment">// Ajoute les mailles du matériau 1</span></div>
<div class="line">      modifier.addCells(env1-&gt;materials()[0],mat1_indexes);</div>
<div class="line">      <span class="comment">// Ajoute les mailles du matériau 2</span></div>
<div class="line">      modifier.addCells(env1-&gt;materials()[1],mat2_indexes);</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">// A partir d&#39;ici, les matériaux sont mis à jour.</span></div>
<div class="line">    info() &lt;&lt; env1-&gt;materials()[0]-&gt;cells().size(); <span class="comment">// Nombre de mailles du matériau</span></div>
<div class="ttc" id="aItemEnumerator_8h_html_aaf5910d68ad8428248f844535ab071f3"><div class="ttname"><a href="../../d6/d0f/ItemEnumerator_8h.html#aaf5910d68ad8428248f844535ab071f3">ENUMERATE_CELL</a></div><div class="ttdeci">#define ENUMERATE_CELL(name, group)</div><div class="ttdoc">Enumérateur générique d'un groupe de mailles.</div><div class="ttdef"><b>Definition</b> <a href="../../d6/d0f/ItemEnumerator_8h_source.html#l00420">ItemEnumerator.h:420</a></div></div>
</div><!-- fragment --><h1><a class="anchor" id="arcanedoc_materials_manage_iteration"></a>
Itération sur les mailles matériaux</h1>
<p>Il existe trois classes pour faire référence aux notions de maille matériaux :</p><ul>
<li>AllEnvCell est une classe permettant d'accéder à l'ensemble des milieux d'une maille.</li>
<li>EnvCell correspond à un milieu d'une maille et permet d'accéder aux valeurs de ce milieu pour cette maille et à l'ensemble des valeurs de cette maille pour les matériaux de ce milieu.</li>
<li>MatCell correspondant à une valeur d'un matériau d'un milieu d'une maille.</li>
</ul>
<p>Il existe une quatrième classe ComponentCell qui n'est pas une maille spécifique mais qui peut représenter un des trois types ci-dessus et permet d'unifier les traitements (voir <a class="el" href="../../de/d9b/arcanedoc_materials_manage.html#arcanedoc_materials_manage_component">Unification</a>).</p>
<p>Il existe deux manières d'itérer sur les mailles matériaux.</p>
<p>La première est d'itérer sur tous les milieux, pour chaque milieu d'itérer sur les matériaux de ce milieu et pour chacun de ces matériaux d'itérer sur ces mailles. Par exemple :</p>
<div class="fragment"><div class="line">    <span class="comment">// Itération sur tous les milieux, puis tous les matériaux et</span></div>
<div class="line">    <span class="comment">// toutes les mailles de ce matériau</span></div>
<div class="line">    <a class="code hl_define" href="../../dd/df0/core_2materials_2MatItemEnumerator_8h.html#a42e9f542db51c49120e75519bca39a35">ENUMERATE_ENV</a>(ienv,material_mng){</div>
<div class="line">      IMeshEnvironment* env = *ienv;</div>
<div class="line">      <a class="code hl_define" href="../../dd/df0/core_2materials_2MatItemEnumerator_8h.html#afe0d487f593214b682fd6b9319b38aa2">ENUMERATE_MAT</a>(imat,env){</div>
<div class="line">        IMeshMaterial* mat = *imat;</div>
<div class="line">        <a class="code hl_define" href="../../dd/df0/core_2materials_2MatItemEnumerator_8h.html#ab9c458f7fd0f80713f8229a6fcb9e3c0">ENUMERATE_MATCELL</a>(imatcell,mat){</div>
<div class="line">          MatCell mc = *imatcell;</div>
<div class="line">          info() &lt;&lt; <span class="stringliteral">&quot;Cell mat=&quot;</span> &lt;&lt; mc.materialId();</div>
<div class="line">        }</div>
<div class="line">      }</div>
<div class="line">      <a class="code hl_define" href="../../dd/df0/core_2materials_2MatItemEnumerator_8h.html#a568f790f7de72e2144399d55d8c63455">ENUMERATE_ENVCELL</a>(ienvcell,env){</div>
<div class="line">        EnvCell mmcell = *ienvcell;</div>
<div class="line">        info() &lt;&lt; <span class="stringliteral">&quot;Cell env=&quot;</span> &lt;&lt; mmcell.environmentId();</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="ttc" id="acore_2materials_2MatItemEnumerator_8h_html_a42e9f542db51c49120e75519bca39a35"><div class="ttname"><a href="../../dd/df0/core_2materials_2MatItemEnumerator_8h.html#a42e9f542db51c49120e75519bca39a35">ENUMERATE_ENV</a></div><div class="ttdeci">#define ENUMERATE_ENV(ienv, container)</div><div class="ttdoc">Macro pour itérer sur une liste de milieux.</div><div class="ttdef"><b>Definition</b> <a href="../../dd/df0/core_2materials_2MatItemEnumerator_8h_source.html#l00631">core/materials/MatItemEnumerator.h:631</a></div></div>
<div class="ttc" id="acore_2materials_2MatItemEnumerator_8h_html_a568f790f7de72e2144399d55d8c63455"><div class="ttname"><a href="../../dd/df0/core_2materials_2MatItemEnumerator_8h.html#a568f790f7de72e2144399d55d8c63455">ENUMERATE_ENVCELL</a></div><div class="ttdeci">#define ENUMERATE_ENVCELL(iname, env)</div><div class="ttdoc">Macro pour itérer sur toutes les mailles d'un milieu.</div><div class="ttdef"><b>Definition</b> <a href="../../dd/df0/core_2materials_2MatItemEnumerator_8h_source.html#l00588">core/materials/MatItemEnumerator.h:588</a></div></div>
<div class="ttc" id="acore_2materials_2MatItemEnumerator_8h_html_ab9c458f7fd0f80713f8229a6fcb9e3c0"><div class="ttname"><a href="../../dd/df0/core_2materials_2MatItemEnumerator_8h.html#ab9c458f7fd0f80713f8229a6fcb9e3c0">ENUMERATE_MATCELL</a></div><div class="ttdeci">#define ENUMERATE_MATCELL(iname, mat)</div><div class="ttdoc">Macro pour itérer sur toutes les mailles d'un matériau.</div><div class="ttdef"><b>Definition</b> <a href="../../dd/df0/core_2materials_2MatItemEnumerator_8h_source.html#l00579">core/materials/MatItemEnumerator.h:579</a></div></div>
<div class="ttc" id="acore_2materials_2MatItemEnumerator_8h_html_afe0d487f593214b682fd6b9319b38aa2"><div class="ttname"><a href="../../dd/df0/core_2materials_2MatItemEnumerator_8h.html#afe0d487f593214b682fd6b9319b38aa2">ENUMERATE_MAT</a></div><div class="ttdeci">#define ENUMERATE_MAT(imat, container)</div><div class="ttdoc">Macro pour itérer sur une liste de matériaux.</div><div class="ttdef"><b>Definition</b> <a href="../../dd/df0/core_2materials_2MatItemEnumerator_8h_source.html#l00619">core/materials/MatItemEnumerator.h:619</a></div></div>
</div><!-- fragment --><p>Il est aussi possible d'utiliser un bloc pour itérer uniquement sur les milieux de ce bloc au lieu d'itérer sur tous les milieux :</p>
<div class="fragment"><div class="line">    <span class="comment">// Itération sur tous les mailles des matériaux des milieux d&#39;un bloc.</span></div>
<div class="line">    <a class="code hl_define" href="../../dd/df0/core_2materials_2MatItemEnumerator_8h.html#a42e9f542db51c49120e75519bca39a35">ENUMERATE_ENV</a>(ienv,block){</div>
<div class="line">      IMeshEnvironment* env = *ienv;</div>
<div class="line">      <a class="code hl_define" href="../../dd/df0/core_2materials_2MatItemEnumerator_8h.html#afe0d487f593214b682fd6b9319b38aa2">ENUMERATE_MAT</a>(imat,env){</div>
<div class="line">        IMeshMaterial* mat = *imat;</div>
<div class="line">        <a class="code hl_define" href="../../dd/df0/core_2materials_2MatItemEnumerator_8h.html#ab9c458f7fd0f80713f8229a6fcb9e3c0">ENUMERATE_MATCELL</a>(imatcell,mat){</div>
<div class="line">          MatCell mc = *imatcell;</div>
<div class="line">          info() &lt;&lt; <span class="stringliteral">&quot;Cell mat=&quot;</span> &lt;&lt; mc.materialId();</div>
<div class="line">        }</div>
<div class="line">      }</div>
<div class="line">    }</div>
</div><!-- fragment --><p>La seconde manière est de parcourir toutes les mailles d'un groupe de maille, puis pour chaque maille d'itérer sur ses milieux et sur les matériaux de ses milieux. Pour cela, on peut utiliser la macro ENUMERATE_ALLENVCELL, de la même manière que la macro ENUMERATE_CELL, mais en spécifiant en plus le gestionnaire de matériaux. Par exemple, si on souhaite itérer sur toutes les mailles (groupe allCells())</p>
<div class="fragment"><div class="line">    <span class="comment">// Itération sur tous les milieux et tous les matériaux d&#39;une maille.</span></div>
<div class="line">    <a class="code hl_define" href="../../dd/df0/core_2materials_2MatItemEnumerator_8h.html#abb8f4d71c522752b85f2239cfab71b94">ENUMERATE_ALLENVCELL</a>(iallenvcell,material_mng,allCells()){</div>
<div class="line">      AllEnvCell all_env_cell = *iallenvcell;</div>
<div class="line">      <a class="code hl_define" href="../../dd/df0/core_2materials_2MatItemEnumerator_8h.html#a98a6ae7a597e04e3f6dec2e55ebbc2a2">ENUMERATE_CELL_ENVCELL</a>(ienvcell,all_env_cell){</div>
<div class="line">        EnvCell env_cell = *ienvcell;</div>
<div class="line">        info() &lt;&lt; <span class="stringliteral">&quot;Cell env=&quot;</span> &lt;&lt; env_cell.environmentId();</div>
<div class="line">        <a class="code hl_define" href="../../dd/df0/core_2materials_2MatItemEnumerator_8h.html#a647a50880bb9a7712d924e674a746cc6">ENUMERATE_CELL_MATCELL</a>(imatcell,env_cell){</div>
<div class="line">          MatCell mc = *imatcell;</div>
<div class="line">          info() &lt;&lt; <span class="stringliteral">&quot;Cell mat=&quot;</span> &lt;&lt; mc.materialId();</div>
<div class="line">        }</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="ttc" id="acore_2materials_2MatItemEnumerator_8h_html_a647a50880bb9a7712d924e674a746cc6"><div class="ttname"><a href="../../dd/df0/core_2materials_2MatItemEnumerator_8h.html#a647a50880bb9a7712d924e674a746cc6">ENUMERATE_CELL_MATCELL</a></div><div class="ttdeci">#define ENUMERATE_CELL_MATCELL(iname, env_cell)</div><div class="ttdoc">Macro pour itérer sur tous les matériaux d'une maille.</div><div class="ttdef"><b>Definition</b> <a href="../../dd/df0/core_2materials_2MatItemEnumerator_8h_source.html#l00649">core/materials/MatItemEnumerator.h:649</a></div></div>
<div class="ttc" id="acore_2materials_2MatItemEnumerator_8h_html_a98a6ae7a597e04e3f6dec2e55ebbc2a2"><div class="ttname"><a href="../../dd/df0/core_2materials_2MatItemEnumerator_8h.html#a98a6ae7a597e04e3f6dec2e55ebbc2a2">ENUMERATE_CELL_ENVCELL</a></div><div class="ttdeci">#define ENUMERATE_CELL_ENVCELL(iname, all_env_cell)</div><div class="ttdoc">Macro pour itérer sur tous les milieux d'une maille.</div><div class="ttdef"><b>Definition</b> <a href="../../dd/df0/core_2materials_2MatItemEnumerator_8h_source.html#l00658">core/materials/MatItemEnumerator.h:658</a></div></div>
<div class="ttc" id="acore_2materials_2MatItemEnumerator_8h_html_abb8f4d71c522752b85f2239cfab71b94"><div class="ttname"><a href="../../dd/df0/core_2materials_2MatItemEnumerator_8h.html#abb8f4d71c522752b85f2239cfab71b94">ENUMERATE_ALLENVCELL</a></div><div class="ttdeci">#define ENUMERATE_ALLENVCELL(iname,...)</div><div class="ttdoc">Macro pour itérer sur toutes les mailles AllEnvCell d'un groupe.</div><div class="ttdef"><b>Definition</b> <a href="../../dd/df0/core_2materials_2MatItemEnumerator_8h_source.html#l00570">core/materials/MatItemEnumerator.h:570</a></div></div>
</div><!-- fragment --><p>De la même manière, en itérant sur toutes les mailles d'un bloc :</p>
<div class="fragment"><div class="line">    <span class="comment">// Itération sur tous les milieux et tous les matériaux d&#39;une maille.</span></div>
<div class="line">    <a class="code hl_define" href="../../dd/df0/core_2materials_2MatItemEnumerator_8h.html#abb8f4d71c522752b85f2239cfab71b94">ENUMERATE_ALLENVCELL</a>(iallenvcell,block){</div>
<div class="line">      AllEnvCell all_env_cell = *iallenvcell;</div>
<div class="line">      <a class="code hl_define" href="../../dd/df0/core_2materials_2MatItemEnumerator_8h.html#a98a6ae7a597e04e3f6dec2e55ebbc2a2">ENUMERATE_CELL_ENVCELL</a>(ienvcell,all_env_cell){</div>
<div class="line">        EnvCell env_cell = *ienvcell;</div>
<div class="line">        info() &lt;&lt; <span class="stringliteral">&quot;Cell env=&quot;</span> &lt;&lt; env_cell.environmentId();</div>
<div class="line">        <a class="code hl_define" href="../../dd/df0/core_2materials_2MatItemEnumerator_8h.html#a647a50880bb9a7712d924e674a746cc6">ENUMERATE_CELL_MATCELL</a>(imatcell,env_cell){</div>
<div class="line">          MatCell mc = *imatcell;</div>
<div class="line">          info() &lt;&lt; <span class="stringliteral">&quot;Cell mat=&quot;</span> &lt;&lt; mc.materialId();</div>
<div class="line">        }</div>
<div class="line">      }</div>
<div class="line">    }</div>
</div><!-- fragment --><p>Il existe une troisième manière pour itérer sur les mailles d'un matériau ou d'un milieu. Les classes MatCellVector et EnvCellVector permettent d'obtenir une liste de MatCell ou de EnvCell à partir d'un groupe de mailles et d'un matériau ou d'un mileu. L'exemple suivant montre comment récupérer la liste des mailles du matériau <em>mat</em> et du milieu \env correspondant au groupe <em>cells</em> pour positionner une variable <em>mat_density</em> :</p>
<div class="fragment"><div class="line">    CellGroup cells;</div>
<div class="line">    IMeshMaterial* mat = env1-&gt;materials()[0];</div>
<div class="line">    MatCellVector mat_cells(cells,mat);</div>
<div class="line">    <a class="code hl_define" href="../../dd/df0/core_2materials_2MatItemEnumerator_8h.html#ab9c458f7fd0f80713f8229a6fcb9e3c0">ENUMERATE_MATCELL</a>(imatcell,mat_cells){</div>
<div class="line">      mat_density[imatcell] = 2.3;</div>
<div class="line">    }</div>
<div class="line">    IMeshEnvironment* env = env1;</div>
<div class="line">    EnvCellVector env_cells(cells,env);</div>
<div class="line">    <a class="code hl_define" href="../../dd/df0/core_2materials_2MatItemEnumerator_8h.html#a568f790f7de72e2144399d55d8c63455">ENUMERATE_ENVCELL</a>(imatcell,env_cells){</div>
<div class="line">      mat_density[imatcell] = 3.1;</div>
<div class="line">    }</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>Actuellement, les classes MatCellVector et EnvCellVector ne sont pas copiables et ne sont valides que tant que le matériau (pour MatCellVector) ou le milieu (pour EnvCellVector) et le groupe de maille associé ne change pas. De plus, la conservation des informations consomme de la mémoire et la création à un cout en temps de calcul proportionnel au nombre de mailles du groupe.</dd></dl>
<h1><a class="anchor" id="arcanedoc_materials_manage_conversion"></a>
Conversion Cell vers AllEnvCell, MatCell ou EnvCell</h1>
<p>La plupart des méthodes sur les entités retournent des objets de type <em>Cell</em>. Pour convertir ces objets en le type <em>AllEnvCell</em> afin d'avoir les infos sur les matériaux, il faut passer par une instance de CellToAllEnvCellConverter. Ce convertisseur peut par exemple être créé en début de fonction car son coût de création est négligeable.</p>
<div class="fragment"><div class="line"><a class="code hl_class" href="../../d5/dd2/classArcane_1_1Materials_1_1CellToAllEnvCellConverter.html">CellToAllEnvCellConverter</a> <a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">all_env_cell_converter</a>(m_material_mng);</div>
<div class="line"><a class="code hl_class" href="../../d9/db2/classArcane_1_1Cell.html">Cell</a> cell = ...;</div>
<div class="line"><a class="code hl_class" href="../../d1/d25/classArcane_1_1Materials_1_1AllEnvCell.html">AllEnvCell</a> <a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">allenvcell</a> = <a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">all_env_cell_converter</a>[cell];</div>
<div class="ttc" id="aclassArcane_1_1Cell_html"><div class="ttname"><a href="../../d9/db2/classArcane_1_1Cell.html">Arcane::Cell</a></div><div class="ttdoc">Maille d'un maillage.</div><div class="ttdef"><b>Definition</b> <a href="../../d1/dd4/Item_8h_source.html#l01169">Item.h:1171</a></div></div>
<div class="ttc" id="aclassArcane_1_1Materials_1_1AllEnvCell_html"><div class="ttname"><a href="../../d1/d25/classArcane_1_1Materials_1_1AllEnvCell.html">Arcane::Materials::AllEnvCell</a></div><div class="ttdoc">Maille arcane avec info matériaux et milieux.</div><div class="ttdef"><b>Definition</b> <a href="../../d3/d9f/core_2materials_2MatItem_8h_source.html#l00164">core/materials/MatItem.h:166</a></div></div>
<div class="ttc" id="aclassArcane_1_1Materials_1_1CellToAllEnvCellConverter_html"><div class="ttname"><a href="../../d5/dd2/classArcane_1_1Materials_1_1CellToAllEnvCellConverter.html">Arcane::Materials::CellToAllEnvCellConverter</a></div><div class="ttdoc">Conversion de 'Cell' en 'AllEnvCell'.</div><div class="ttdef"><b>Definition</b> <a href="../../d2/d51/core_2materials_2CellToAllEnvCellConverter_8h_source.html#l00070">core/materials/CellToAllEnvCellConverter.h:71</a></div></div>
<div class="ttc" id="aclassArcane_1_1ScopedPtrT_html"><div class="ttname"><a href="../../db/d19/classArcane_1_1ScopedPtrT.html">Arcane::ScopedPtrT</a></div><div class="ttdoc">Encapsulation d'un pointeur qui se détruit automatiquement.</div><div class="ttdef"><b>Definition</b> <a href="../../d7/d84/ScopedPtr_8h_source.html#l00042">ScopedPtr.h:44</a></div></div>
</div><!-- fragment --><p>À partir d'une AllEnvCell, il est possible de récupérer directement une maille pour un matériau ou un milieu donné via IMeshMaterial::findMatCell() ou IMeshEnvironment::findEnvCell(). Ces méthodes retournent respectivement une MatCell ou une EnvCell correspondant à la maille matériau ou milieu souhaité. L'instance retournée peut-être nulle si le matériau ou le milieu n'est pas présent dans la maille. Par exemple :</p>
<div class="fragment"><div class="line"><a class="code hl_class" href="../../d1/d25/classArcane_1_1Materials_1_1AllEnvCell.html">AllEnvCell</a> <a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">allenvcell</a> = ...;</div>
<div class="line"><a class="code hl_class" href="../../d9/ddb/classArcane_1_1Materials_1_1IMeshMaterial.html">IMeshMaterial</a>* <a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">mat</a> = ...;</div>
<div class="line"><a class="code hl_class" href="../../da/d7c/classArcane_1_1Materials_1_1MatCell.html">MatCell</a> <a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">matcell</a> = <a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">mat</a>-&gt;findMatCell(<a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">allenvcell</a>);</div>
<div class="line"><span class="keywordflow">if</span> (<a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">matcell</a>.null())</div>
<div class="line">  <span class="comment">// Materiau absent de la maille</span></div>
<div class="line">  ...</div>
<div class="line">IMeshEnvironment* <a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">env</a> = ...;</div>
<div class="line"><a class="code hl_class" href="../../de/dd0/classArcane_1_1Materials_1_1EnvCell.html">EnvCell</a> <a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">envcell</a> = <a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">env</a>-&gt;findEnvCell(<a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">allenvcell</a>);</div>
<div class="line"><span class="keywordflow">if</span> (<a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">envcell</a>.null())</div>
<div class="line">  <span class="comment">// Milieu absent de la maille.</span></div>
<div class="line">  ...</div>
<div class="ttc" id="aclassArcane_1_1Materials_1_1EnvCell_html"><div class="ttname"><a href="../../de/dd0/classArcane_1_1Materials_1_1EnvCell.html">Arcane::Materials::EnvCell</a></div><div class="ttdoc">Maille arcane d'un milieu.</div><div class="ttdef"><b>Definition</b> <a href="../../d3/d9f/core_2materials_2MatItem_8h_source.html#l00104">core/materials/MatItem.h:106</a></div></div>
<div class="ttc" id="aclassArcane_1_1Materials_1_1IMeshMaterial_html"><div class="ttname"><a href="../../d9/ddb/classArcane_1_1Materials_1_1IMeshMaterial.html">Arcane::Materials::IMeshMaterial</a></div><div class="ttdoc">Interface d'un matériau d'un maillage.</div><div class="ttdef"><b>Definition</b> <a href="../../df/d7d/core_2materials_2IMeshMaterial_8h_source.html#l00051">core/materials/IMeshMaterial.h:53</a></div></div>
<div class="ttc" id="aclassArcane_1_1Materials_1_1MatCell_html"><div class="ttname"><a href="../../da/d7c/classArcane_1_1Materials_1_1MatCell.html">Arcane::Materials::MatCell</a></div><div class="ttdoc">Représente un matériau d'une maille multi-matériau.</div><div class="ttdef"><b>Definition</b> <a href="../../d3/d9f/core_2materials_2MatItem_8h_source.html#l00047">core/materials/MatItem.h:49</a></div></div>
</div><!-- fragment --><h1><a class="anchor" id="arcanedoc_materials_manage_component"></a>
Unification</h1>
<p>Depuis la version 1.21.0 de Arcane, il est possible de traiter les mailles matériaux et milieu de manière générique. La classe ComponentCell permet cette unification et peut s'utiliser pour tous les types de mailles MatCell, EnvCell ou AllEnvCell. La macro <a class="el" href="../../dd/df0/core_2materials_2MatItemEnumerator_8h.html#ad0a44976a632ca375796818664c67977" title="Macro pour itérer sur toutes les mailles d&#39;un composant.">ENUMERATE_COMPONENTCELL()</a> permet d'itérer sur des mailles de ce type :</p>
<div class="fragment"><div class="line">    <span class="comment">// Itération sur tous les milieux, puis tous les matériaux et</span></div>
<div class="line">    <span class="comment">// toutes les mailles de ce matériau via la ComponentCell</span></div>
<div class="line">    <a class="code hl_define" href="../../dd/df0/core_2materials_2MatItemEnumerator_8h.html#a42e9f542db51c49120e75519bca39a35">ENUMERATE_ENV</a>(ienv,material_mng){</div>
<div class="line">      IMeshEnvironment* env = *ienv;</div>
<div class="line">      <a class="code hl_define" href="../../dd/df0/core_2materials_2MatItemEnumerator_8h.html#afe0d487f593214b682fd6b9319b38aa2">ENUMERATE_MAT</a>(imat,env){</div>
<div class="line">        IMeshMaterial* mat = *imat;</div>
<div class="line">        <a class="code hl_define" href="../../dd/df0/core_2materials_2MatItemEnumerator_8h.html#ad0a44976a632ca375796818664c67977">ENUMERATE_COMPONENTCELL</a>(iccell,mat){</div>
<div class="line">          ComponentCell cc = *iccell;</div>
<div class="line">          info() &lt;&lt; <span class="stringliteral">&quot;Cell mat=&quot;</span> &lt;&lt; cc.componentId();</div>
<div class="line">          mat_density[cc] = 3.1; <span class="comment">// Met à jour la densité du matériau</span></div>
<div class="line">        }</div>
<div class="line">      }</div>
<div class="line">      <a class="code hl_define" href="../../dd/df0/core_2materials_2MatItemEnumerator_8h.html#ad0a44976a632ca375796818664c67977">ENUMERATE_COMPONENTCELL</a>(iccell,env){</div>
<div class="line">        ComponentCell cc = *iccell;</div>
<div class="line">        info() &lt;&lt; <span class="stringliteral">&quot;Cell env=&quot;</span> &lt;&lt; cc.componentId();</div>
<div class="line">        mat_density[cc] = 2.5; <span class="comment">// Met à jour la densité du milieu</span></div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="ttc" id="acore_2materials_2MatItemEnumerator_8h_html_ad0a44976a632ca375796818664c67977"><div class="ttname"><a href="../../dd/df0/core_2materials_2MatItemEnumerator_8h.html#ad0a44976a632ca375796818664c67977">ENUMERATE_COMPONENTCELL</a></div><div class="ttdeci">#define ENUMERATE_COMPONENTCELL(iname, component)</div><div class="ttdoc">Macro pour itérer sur toutes les mailles d'un composant.</div><div class="ttdef"><b>Definition</b> <a href="../../dd/df0/core_2materials_2MatItemEnumerator_8h_source.html#l00597">core/materials/MatItemEnumerator.h:597</a></div></div>
</div><!-- fragment --><p>La classe ComponentCell peut aussi servir à indexer une variable comme le ferait une MatCell ou une EnvCell.</p>
<p>De la même manière, l'interface IMeshComponent est maintenant l'interface de base de IMeshMaterial et IMeshEnvironment et les méthodes IMeshMaterialMng::materialsAsComponents() et IMeshMaterialMng::environmentsAsComponents() permettent de traiter les listes de matériaux et milieux de la même manière sous forme de liste de IMeshComponent. Enfin, la classe ComponentCellVector permet de créer un vecteur de ComponentCell et s'utiliser comme un EnvCellVector ou MatCellVector</p>
<p>La méthode ComponentCell::superCell() retourne la ComponentCell de niveau hiérarchique immédiatement supérieur. Il est aussi possible d'itérer sur les sous-mailles d'une ComponantCell via la macro <a class="el" href="../../dd/df0/core_2materials_2MatItemEnumerator_8h.html#a2effa51105facd480d81a8ecc6d12b49" title="Macro pour itérer sur tous les composants d&#39;une maille.">ENUMERATE_CELL_COMPONENTCELL()</a> :</p>
<div class="fragment"><div class="line">      MatCell mc;</div>
<div class="line">      ComponentCell cc = mc;</div>
<div class="line">      <span class="comment">// Retourne la maille milieu (EnvCell) du matériau:</span></div>
<div class="line">      ComponentCell cc2 = cc.superCell();</div>
<div class="line">      <span class="comment">// Itère sur les mailles matériaux du milieu</span></div>
<div class="line">      <a class="code hl_define" href="../../dd/df0/core_2materials_2MatItemEnumerator_8h.html#a2effa51105facd480d81a8ecc6d12b49">ENUMERATE_CELL_COMPONENTCELL</a>(icc,cc2){</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">      <span class="comment">// Retourne la maille AllEnvCell du milieu:</span></div>
<div class="line">      ComponentCell cc3 = cc2.superCell();</div>
<div class="line">      <span class="comment">// Itère sur les mailles milieu de la maille.</span></div>
<div class="line">      <a class="code hl_define" href="../../dd/df0/core_2materials_2MatItemEnumerator_8h.html#a2effa51105facd480d81a8ecc6d12b49">ENUMERATE_CELL_COMPONENTCELL</a>(icc,cc3){</div>
<div class="line">      }</div>
<div class="ttc" id="acore_2materials_2MatItemEnumerator_8h_html_a2effa51105facd480d81a8ecc6d12b49"><div class="ttname"><a href="../../dd/df0/core_2materials_2MatItemEnumerator_8h.html#a2effa51105facd480d81a8ecc6d12b49">ENUMERATE_CELL_COMPONENTCELL</a></div><div class="ttdeci">#define ENUMERATE_CELL_COMPONENTCELL(iname, component_cell)</div><div class="ttdoc">Macro pour itérer sur tous les composants d'une maille.</div><div class="ttdef"><b>Definition</b> <a href="../../dd/df0/core_2materials_2MatItemEnumerator_8h_source.html#l00640">core/materials/MatItemEnumerator.h:640</a></div></div>
</div><!-- fragment --><p>Enfin, il existe une macro <a class="el" href="../../dd/df0/core_2materials_2MatItemEnumerator_8h.html#a6de83a125a79d459704208970e42b244" title="Macro pour itérer sur une liste de composants.">ENUMERATE_COMPONENT()</a> qui permet d'itérer sur une liste de composants, et qui peut donc se substituer à <a class="el" href="../../dd/df0/core_2materials_2MatItemEnumerator_8h.html#afe0d487f593214b682fd6b9319b38aa2" title="Macro pour itérer sur une liste de matériaux.">ENUMERATE_MAT()</a> ou <a class="el" href="../../dd/df0/core_2materials_2MatItemEnumerator_8h.html#a42e9f542db51c49120e75519bca39a35" title="Macro pour itérer sur une liste de milieux.">ENUMERATE_ENV()</a>.</p>
<h1><a class="anchor" id="arcanedoc_materials_manage_variable"></a>
Variables matériaux</h1>
<dl class="section note"><dt>Note</dt><dd>Depuis la version 2.4.0 il est possible de déclarer des variables uniquement sur les milieux et qui n'ont pas de valeurs sur les matériaux. Pour plus d'infos voir la section <a class="el" href="../../dd/d30/arcanedoc_execution_env_variables.html">Variables d'environnement</a>.</dd></dl>
<p>Les variables matériaux sont similaires aux variables de maillage mais possèdent en plus de la valeur aux mailles classiques une valeur par matériau et par milieu présent dans la maille. Pour une maille qui a 3 milieux, avec 2 matériaux pour le milieu 1, 3 pour le milieu 2 et 5 pour le milieu 3, le nombre de valeurs est donc de 14 (10 pour les matériaux, 3 pour les milieux et 1 pour la valeur globale). Les valeurs par matériaux et par milieux sont appelées des valeurs partielles.</p>
<p>Actuellement, les variables matériaux sont uniquement disponibles aux mailles. La classe de base gérant ces variables est MeshMaterialVariableRef. Les types possibles sont les suivants et sont définis dans le fichier <code>"MeshMaterialVariableRef.h"</code>.</p>
<table class="doxtable">
<tr>
<th>Nom</th><th>Description </th></tr>
<tr>
<td>#MaterialVariableCellByte</td><td>variable matériau de type '#Byte' </td></tr>
<tr>
<td>#MaterialVariableCellReal</td><td>variable matériau de type '#Real' </td></tr>
<tr>
<td>#MaterialVariableCellInt16</td><td>variable matériau de type 'Int16' </td></tr>
<tr>
<td>#MaterialVariableCellInt32</td><td>variable matériau de type 'Int32' </td></tr>
<tr>
<td>#MaterialVariableCellInt64</td><td>variable matériau de type 'Int64' </td></tr>
<tr>
<td>#MaterialVariableCellReal2</td><td>variable matériau de type '#Real2' </td></tr>
<tr>
<td>#MaterialVariableCellReal3</td><td>variable matériau de type '#Real3' </td></tr>
<tr>
<td>#MaterialVariableCellReal2x2</td><td>variable matériau de type '#Real2x2' </td></tr>
<tr>
<td>#MaterialVariableCellReal3x3</td><td>variable matériau de type '#Real3x3' </td></tr>
</table>
<p>Depuis la version 2.3.8, il est possible de définir des variables tableaux sur les matériaux, qui ont le type suivant :</p>
<table class="doxtable">
<tr>
<th>Nom</th><th>Description </th></tr>
<tr>
<td>#MaterialVariableCellArrayByte</td><td>variable matériau de type tableau de '#Byte' </td></tr>
<tr>
<td>#MaterialVariableCellArrayReal</td><td>variable matériau de type tableau de '#Real' </td></tr>
<tr>
<td>#MaterialVariableCellArrayInt16</td><td>variable matériau de type tableau de 'Int16' </td></tr>
<tr>
<td>#MaterialVariableCellArrayInt32</td><td>variable matériau de type tableau de 'Int32' </td></tr>
<tr>
<td>#MaterialVariableCellArrayInt64</td><td>variable matériau de type tableau de 'Int64' </td></tr>
<tr>
<td>#MaterialVariableCellArrayReal2</td><td>variable matériau de type tableau de '#Real2' </td></tr>
<tr>
<td>#MaterialVariableCellArrayReal3</td><td>variable matériau de type tableau de '#Real3' </td></tr>
<tr>
<td>#MaterialVariableCellArrayReal2x2</td><td>variable matériau de type tableau de '#Real2x2' </td></tr>
<tr>
<td>#MaterialVariableCellArrayReal3x3</td><td>variable matériau de type tableau de '#Real3x3' </td></tr>
</table>
<dl class="section note"><dt>Note</dt><dd>Pour information, en interne d'<a class="el" href="../../d0/d32/namespaceArcane.html" title="-*- tab-width: 2; indent-tabs-mode: nil; coding: utf-8-with-signature -*-">Arcane</a>, ces valeurs partielles sont gérées sous forme de variable tableau classique mais cette implémentation peut évoluer. Depuis la version 2.0 de Arcane, pour pouvoir distinguer ces variables des variables classiques, elles sont taggées avec la valeur "Material". Par exemple, la commande <div class="fragment"><div class="line"><a class="code hl_class" href="../../d5/d96/classArcane_1_1IVariable.html">IVariable</a>* <a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">var</a> = ...;</div>
<div class="line"><span class="keywordflow">if</span> (<a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">var</a>-&gt;hasTag(<span class="stringliteral">&quot;Material&quot;</span>)){</div>
<div class="line">  <span class="comment">// Il s&#39;agit d&#39;une valeur partielle.</span></div>
<div class="line">}</div>
<div class="ttc" id="aclassArcane_1_1IVariable_html"><div class="ttname"><a href="../../d5/d96/classArcane_1_1IVariable.html">Arcane::IVariable</a></div><div class="ttdef"><b>Definition</b> <a href="../../d2/db3/IVariable_8h_source.html#l00053">IVariable.h:54</a></div></div>
</div><!-- fragment --></dd></dl>
<p>Pour l'instant, il n'est possible de créer que des variables scalaires aux mailles, avec l'un des types de donnée suivante : #Real, Int32, Int64, Real2, Real3, Real2x2 ou Real3x3. Le nom de la classe correspondante est le même que pour les variables classiques, mais préfixé de 'Material'. Par exemple, pour une variable de type Real3, le nom est <em>MaterialVariableCellReal3</em>.</p>
<h2><a class="anchor" id="arcanedoc_materials_manage_variable_build"></a>
Construction</h2>
<p>La déclaration des variables matériaux se fait d'une manière similaire à celle des variables du maillage. Il est aussi possible de les déclarer dans le fichier axl, de la même manière qu'une variable classique, en ajoutant l'attribut <code>material</code> avec la valeur <code>true</code>. Les valeurs valides pour <code>dimension</code> sont <code>0</code> ou <code>1</code>.</p>
<div class="fragment"><div class="line">&lt;<span class="keywordtype">variable</span> <span class="keyword">field-name</span>=<span class="stringliteral">&quot;mat_density&quot;</span></div>
<div class="line">         <span class="keyword">name</span>=<span class="stringliteral">&quot;Density&quot;</span></div>
<div class="line">         <span class="keyword">data-type</span>=<span class="stringliteral">&quot;real&quot;</span></div>
<div class="line">         <span class="keyword">item-kind</span>=<span class="stringliteral">&quot;cell&quot;</span></div>
<div class="line">         <span class="keyword">dim</span>=<span class="stringliteral">&quot;0&quot;</span></div>
<div class="line">         <span class="keyword">material</span>=<span class="stringliteral">&quot;true&quot;</span></div>
<div class="line">/&gt;</div>
</div><!-- fragment --><p>La construction se fait avec un objet du type MaterialVariableBuildInfo qui référence le IMeshMaterialMng correspondant ou alors de la même manière qu'une variable classique, via le VariableBuildInfo. Par exemple :</p>
<div class="fragment"><div class="line">    IMesh* mesh = defaultMesh();</div>
<div class="line">    MaterialVariableBuildInfo mvbinfo(material_mng,<span class="stringliteral">&quot;Density&quot;</span>);</div>
<div class="line">    MaterialVariableCellReal mat_density(mvbinfo);</div>
<div class="line">    MaterialVariableCellReal mat_pressure(VariableBuildInfo(mesh,<span class="stringliteral">&quot;Pressure&quot;</span>));</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>La construction des variables matériaux est thread-safe.</dd></dl>
<p>Comme pour les variables classiques, les instructions précédentes ne créent une variable que si aucune de même nom n'existe. Dans le cas contraire, elles récupèrent une référence à la variable déjà créé correspondante.</p>
<h2><a class="anchor" id="arcanedoc_materials_manage_variable_usage"></a>
Utilisation</h2>
<p>Pour accéder à une valeur d'une variable matériau, il suffit d'utiliser l'opérateur [] avec comme argument un des types ComponentCell, Cell, MatCell, EnvCell ou AllEnvCell.</p>
<div class="fragment"><div class="line"><a class="code hl_class" href="../../d9/db2/classArcane_1_1Cell.html">Cell</a> <a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">global_cell</a>;</div>
<div class="line"><a class="code hl_class" href="../../da/d7c/classArcane_1_1Materials_1_1MatCell.html">MatCell</a> <a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">mat_cell</a>;</div>
<div class="line"><a class="code hl_class" href="../../de/dd0/classArcane_1_1Materials_1_1EnvCell.html">EnvCell</a> <a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">env_cell</a>;</div>
<div class="line"><a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">mat_density</a>[<a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">global_cell</a>]; <span class="comment">// Valeur globale</span></div>
<div class="line"><a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">mat_density</a>[<a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">mat_cell</a>];    <span class="comment">// Valeur pour un matériau</span></div>
<div class="line"><a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">mat_density</a>[<a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">env_cell</a>];    <span class="comment">// Valeur pour un milieu.</span></div>
</div><!-- fragment --><p>La valeur globale est partagée avec celle des variables standards <a class="el" href="../../d0/d32/namespaceArcane.html" title="-*- tab-width: 2; indent-tabs-mode: nil; coding: utf-8-with-signature -*-">Arcane</a> de même nom. Par exemple :</p>
<div class="fragment"><div class="line"><a class="code hl_class" href="../../d5/df0/classArcane_1_1Materials_1_1IMeshMaterialMng.html">IMeshMaterialMng</a>* <a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">material_mng</a> = ...;</div>
<div class="line"><a class="code hl_class" href="../../d0/d44/classArcane_1_1Materials_1_1MaterialVariableBuildInfo.html">MaterialVariableBuildInfo</a> <a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">mat_info</a>(<a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">material_mng</a>,<span class="stringliteral">&quot;Density&quot;</span>))</div>
<div class="line"><a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">MaterialVariableCellReal</a> <a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">mat_density</a>(<a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">mat_info</a>);</div>
<div class="line"><a class="code hl_class" href="../../df/d8a/classArcane_1_1VariableBuildInfo.html">VariableBuildInfo</a> info(defaultMesh(),<span class="stringliteral">&quot;Density&quot;</span>))</div>
<div class="line"><a class="code hl_class" href="../../d7/d20/classArcane_1_1MeshVariableScalarRefT.html">VariableCellReal</a> <a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">density</a>(info);</div>
<div class="line"> </div>
<div class="line"><a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">mat_density</a>[<a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">global_cell</a>] = 3.0;</div>
<div class="line">info() &lt;&lt; <a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">density</a>[<a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">global_cell</a>]; <span class="comment">// Affiche 3.0</span></div>
<div class="ttc" id="aclassArcane_1_1Materials_1_1IMeshMaterialMng_html"><div class="ttname"><a href="../../d5/df0/classArcane_1_1Materials_1_1IMeshMaterialMng.html">Arcane::Materials::IMeshMaterialMng</a></div><div class="ttdoc">Interface du gestionnaire des matériaux et des milieux d'un maillage.</div><div class="ttdef"><b>Definition</b> <a href="../../df/d9c/core_2materials_2IMeshMaterialMng_8h_source.html#l00057">core/materials/IMeshMaterialMng.h:58</a></div></div>
<div class="ttc" id="aclassArcane_1_1Materials_1_1MaterialVariableBuildInfo_html"><div class="ttname"><a href="../../d0/d44/classArcane_1_1Materials_1_1MaterialVariableBuildInfo.html">Arcane::Materials::MaterialVariableBuildInfo</a></div><div class="ttdef"><b>Definition</b> <a href="../../d5/dbb/core_2materials_2MaterialVariableBuildInfo_8h_source.html#l00029">core/materials/MaterialVariableBuildInfo.h:31</a></div></div>
<div class="ttc" id="aclassArcane_1_1MeshVariableScalarRefT_html"><div class="ttname"><a href="../../d7/d20/classArcane_1_1MeshVariableScalarRefT.html">Arcane::MeshVariableScalarRefT&lt; Cell, Real &gt;</a></div></div>
<div class="ttc" id="aclassArcane_1_1VariableBuildInfo_html"><div class="ttname"><a href="../../df/d8a/classArcane_1_1VariableBuildInfo.html">Arcane::VariableBuildInfo</a></div><div class="ttdoc">Paramètres nécessaires à la construction d'une variable.</div><div class="ttdef"><b>Definition</b> <a href="../../d1/d1d/VariableBuildInfo_8h_source.html#l00042">VariableBuildInfo.h:43</a></div></div>
</div><!-- fragment --><p>Il est aussi possible de récupérer la variable globale associée à une variable matériaux, via la méthode globalVariable():</p>
<div class="fragment"><div class="line"><a class="code hl_class" href="../../d5/df0/classArcane_1_1Materials_1_1IMeshMaterialMng.html">IMeshMaterialMng</a>* <a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">material_mng</a> = ...;</div>
<div class="line"><a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">MaterialVariableCellReal</a> <a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">mat_density</a>(<a class="code hl_class" href="../../d0/d44/classArcane_1_1Materials_1_1MaterialVariableBuildInfo.html">MaterialVariableBuildInfo</a>(<a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">material_mng</a>,<span class="stringliteral">&quot;Density&quot;</span>));</div>
<div class="line"><a class="code hl_class" href="../../d7/d20/classArcane_1_1MeshVariableScalarRefT.html">VariableCellReal</a>&amp; <a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">density</a>(<a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">mat_density</a>.globalVariable());</div>
</div><!-- fragment --><p>L'implémentation des variables matériaux a pour but de limiter l'utilisation mémoire. Dans cette optique, les valeurs aux milieux et aux matériaux peuvent utiliser la même zone mémoire et dans ce cas modifier la valeur milieu modifie aussi la valeur matériau et réciproquement. Cela est le cas si les conditions suivantes sont respectées dans une maille <em>cell</em> :</p><ul>
<li>un seul matériau (MAT) dans un milieu (ENV), alors var[MAT]==var[ENV]</li>
<li>un seul milieu (ENV) dans la maille, alors var[ENV] == var[cell]</li>
</ul>
<h2><a class="anchor" id="arcanedoc_materials_manage_variable_synchronize"></a>
Synchronisations</h2>
<p>Il est possible de synchroniser les valeurs des variables matériaux, de la même manière que les variables classiques via la fonction MeshMaterialVariableRef::synchronize().</p>
<dl class="section warning"><dt>Avertissement</dt><dd>Attention, il faut tout de même que les informations sur les matériaux présents soient cohérentes entre tous les sous-domaines : si une maille existe dans plusieurs sous-domaines, elle doit avoir les mêmes matériaux et milieux dans chaque sous-domaine.</dd></dl>
<dl class="section note"><dt>Note</dt><dd>Depuis la version 1.22.3, il est possible de garantir que toutes les informations sur les matériaux et les milieux sont cohérentes entre les sous-domaines en appelant la méthode IMeshMaterialMng::synchronizeMaterialsInCells(). Il est aussi possible de vérifier cette cohérence en appelant IMeshMaterialMng::checkMaterialsInCells().</dd></dl>
<p>Depuis la version 2.3.7, il existe plusieurs implémentations pour la synchronisation. La version par défaut n'est pas optimisée et effectue une synchronisation par matériau enregistré dans IMeshMaterialMng. La version optimisée conseillée est la version 6. Pour l'utiliser, il faut appeler la méthode IMeshMaterialMng::setSynchronizeVariableVersion() avec la valeur 6. Il est aussi possible d'effectuer plusieurs synchronisations en une seule fois via la classe MeshMaterialVariableSynchronizerList. Cela permet d'optimiser les communications en réduisant le nombre de messages entre les processeurs. Par exemple : </p><div class="fragment"><div class="line"><a class="code hl_class" href="../../d5/df0/classArcane_1_1Materials_1_1IMeshMaterialMng.html">IMeshMaterialMng</a>* <a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">material_mng</a> = ...;</div>
<div class="line"><a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">MaterialVariableCellReal</a> <a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">temperature</a> = ...;</div>
<div class="line"><a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">MaterialVariableCellInt32</a> <a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">mat_index</a> = ...;</div>
<div class="line"><a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">MaterialVariableCellReal</a> <a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">pressure</a> = ...;</div>
<div class="line"><span class="comment">// Création de la liste de variables à synchroniser.</span></div>
<div class="line"><a class="code hl_class" href="../../d8/d05/classArcane_1_1Materials_1_1MeshMaterialVariableSynchronizerList.html">MeshMaterialVariableSynchronizerList</a> <a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">mmvsl</a>(<a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">material_mng</a>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Ajoute 3 variables à la liste.</span></div>
<div class="line"><a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">temperatture</a>.synchronize(<a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">mmvsl</a>);</div>
<div class="line"><a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">mat_index</a>.synchronize(<a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">mmvsl</a>);</div>
<div class="line"><a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">pressure</a>.synchronize(<a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">mmvsl</a>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Exécute la synchronisation sur les 3 variables en une fois.</span></div>
<div class="line"><a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">mmvsl</a>.apply();</div>
<div class="ttc" id="aclassArcane_1_1Materials_1_1MeshMaterialVariableSynchronizerList_html"><div class="ttname"><a href="../../d8/d05/classArcane_1_1Materials_1_1MeshMaterialVariableSynchronizerList.html">Arcane::Materials::MeshMaterialVariableSynchronizerList</a></div><div class="ttdoc">Synchronisation d'une liste de variables matériaux.</div><div class="ttdef"><b>Definition</b> <a href="../../d0/dd0/MeshMaterialVariableSynchronizerList_8h_source.html#l00038">MeshMaterialVariableSynchronizerList.h:39</a></div></div>
</div><!-- fragment --><p>Depuis la version 3.6 de <a class="el" href="../../d0/d32/namespaceArcane.html" title="-*- tab-width: 2; indent-tabs-mode: nil; coding: utf-8-with-signature -*-">Arcane</a>, il existe deux autres versions de la synchronisation qui fonctionne de manière identique à la version 6 mais avec les modifications suivantes :</p><ul>
<li>La version 7 n'effectue qu'une seule allocation mémoire pour les buffers d'envoi et de réception (alors que la version 6 effectue autant d'allocation qu'il y a de sous-domaines voisins)</li>
<li>La version 8 qui est identique à la version 7 au détail près que les buffers alloués sont conservés entre deux synchronisations. Cette version permet d'éviter des allocations/désallocations successives au prix d'une augmentation mémoire. Ces deux versions ont pour but d'éviter de faire trop de cycles d'allocations/désallocations qui peuvent demander une charge de travail importante pour les cartes réseaux pour accès directs à la mémoire (RMA).</li>
</ul>
<h2><a class="anchor" id="arcanedoc_materials_manage_variable_dependencies"></a>
Gestion des dépendances</h2>
<p>Depuis la version 1.22.1, il est possible d'utiliser le mécanisme de dépendance sur les variables matériaux. Ce mécanisme est similaire à celui des variables classiques mais permet de gérer les dépendances par matériaux.</p>
<dl class="section note"><dt>Note</dt><dd>Contrairement aux dépendances sur les variables classiques, les dépendances sur les matériaux ne gèrent pas le temps physique et il n'est pas possible par exemple de faire des dépendances sur le temps physique précédent (en spécifiant IVariable::DPT_PreviousTime par exemple).</dd></dl>
<p>Le fonctionnement est le suivant :</p>
<div class="fragment"><div class="line">      <span class="comment">// Positionne la méthode de calcul.</span></div>
<div class="line">      mat_density.setMaterialComputeFunction(<span class="keyword">this</span>,&amp;Sample::_computeDensity);</div>
<div class="line">      <span class="comment">// Ajoute dépendance sur une variable matériau</span></div>
<div class="line">      mat_density.addMaterialDepend(mat_pressure);</div>
<div class="line">      <span class="comment">// Ajoute dépendance sur variables globales</span></div>
<div class="line">      mat_density.addMaterialDepend(defaultMesh()-&gt;nodesCoordinates());</div>
<div class="line">      mat_density.addMaterialDepend(m_global_time);</div>
<div class="line"> </div>
<div class="line">      <a class="code hl_define" href="../../dd/df0/core_2materials_2MatItemEnumerator_8h.html#afe0d487f593214b682fd6b9319b38aa2">ENUMERATE_MAT</a>(imat,material_mng){</div>
<div class="line">        IMeshMaterial* mat = *imat;</div>
<div class="line">        <span class="comment">// Met à jour la variable sur le matériau \a mat si besoin.</span></div>
<div class="line">        mat_density.update(mat);</div>
<div class="line">      }</div>
</div><!-- fragment --><p>Lors de l'appel à MeshMaterialVariableRef::update(), il est nécessaire de spécifier en argument le matériau sur lequel on souhaite faire la mise à jour. La méthode de calcul doit donc avoir comme argument un matériau, et en fin de calcul appeler MeshMaterialVariableRef::setUpToDate(mat) avec <em>mat</em> le matériau recalculé. Par exemple :</p>
<div class="fragment"><div class="line">  <span class="keywordtype">void</span> _computeDensity(IMeshMaterial* mat)</div>
<div class="line">  {</div>
<div class="line">    <a class="code hl_define" href="../../dd/df0/core_2materials_2MatItemEnumerator_8h.html#ab9c458f7fd0f80713f8229a6fcb9e3c0">ENUMERATE_MATCELL</a>(imc,mat){</div>
<div class="line">      MatCell mc = *imc;</div>
<div class="line">      m_mat_density[mc] = 1.0;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Indique que la variable est à jour.</span></div>
<div class="line">    m_mat_density.setUpToDate(mat);</div>
<div class="line">  }</div>
</div><!-- fragment --><h1><a class="anchor" id="arcanedoc_materials_manage_environment_variable"></a>
Variables milieux</h1>
<p>Depuis la version 2.4.0 de Arcane, il est possible de définir des variables qui n'ont de valeurs partielles que sur les milieux et pas sur les matériaux. Mise à part cette différence, elles se comportent comme les variables matériaux. Les variables milieux disponibles sont les suivantes :</p>
<table class="doxtable">
<tr>
<th>Nom</th><th>Description </th></tr>
<tr>
<td>#EnvironmentVariableCellByte</td><td>variable milieu de type '#Byte' </td></tr>
<tr>
<td>#EnvironmentVariableCellReal</td><td>variable milieu de type '#Real' </td></tr>
<tr>
<td>#EnvironmentVariableCellInt16</td><td>variable milieu de type 'Int16' </td></tr>
<tr>
<td>#EnvironmentVariableCellInt32</td><td>variable milieu de type 'Int32' </td></tr>
<tr>
<td>#EnvironmentVariableCellInt64</td><td>variable milieu de type 'Int64' </td></tr>
<tr>
<td>#EnvironmentVariableCellReal2</td><td>variable milieu de type 'Real2' </td></tr>
<tr>
<td>#EnvironmentVariableCellReal3</td><td>variable milieu de type 'Real3' </td></tr>
<tr>
<td>#EnvironmentVariableCellReal2x2</td><td>variable milieu de type 'Real2x2' </td></tr>
<tr>
<td>#EnvironmentVariableCellReal3x3</td><td>variable milieu de type 'Real3x3' </td></tr>
<tr>
<td>#EnvironmentVariableCellArrayByte</td><td>variable milieu de type tableau de '#Byte' </td></tr>
<tr>
<td>#EnvironmentVariableCellArrayReal</td><td>variable milieu de type tableau de '#Real' </td></tr>
<tr>
<td>#EnvironmentVariableCellArrayInt16</td><td>variable milieu de type tableau de 'Int16' </td></tr>
<tr>
<td>#EnvironmentVariableCellArrayInt32</td><td>variable milieu de type tableau de 'Int32' </td></tr>
<tr>
<td>#EnvironmentVariableCellArrayInt64</td><td>variable milieu de type tableau de 'Int64' </td></tr>
<tr>
<td>#EnvironmentVariableCellArrayReal2</td><td>variable milieu de type tableau de 'Real2' </td></tr>
<tr>
<td>#EnvironmentVariableCellArrayReal3</td><td>variable milieu de type tableau de 'Real3' </td></tr>
<tr>
<td>#EnvironmentVariableCellArrayReal2x2</td><td>variable milieu de type tableau de 'Real2x2' </td></tr>
<tr>
<td>#EnvironmentVariableCellArrayReal3x3</td><td>variable milieu de type tableau de 'Real3x3' </td></tr>
</table>
<p>Dans le fichier axl, ces variables peuvent être définies en spécifiant l'attribut <code>environment</code> à <code>true</code>.</p>
<div class="fragment"><div class="line">&lt;<span class="keywordtype">variable</span> <span class="keyword">field-name</span>=<span class="stringliteral">&quot;mat_density&quot;</span></div>
<div class="line">         <span class="keyword">name</span>=<span class="stringliteral">&quot;Density&quot;</span></div>
<div class="line">         <span class="keyword">data-type</span>=<span class="stringliteral">&quot;real&quot;</span></div>
<div class="line">         <span class="keyword">item-kind</span>=<span class="stringliteral">&quot;cell&quot;</span></div>
<div class="line">         <span class="keyword">dim</span>=<span class="stringliteral">&quot;0&quot;</span></div>
<div class="line">         <span class="keyword">environment</span>=<span class="stringliteral">&quot;true&quot;</span></div>
<div class="line">/&gt;</div>
</div><!-- fragment --><dl class="section warning"><dt>Avertissement</dt><dd>Comme les structures internes des mailles matériaux et milieux sont unifiées, il est possible à la compilation d'indexer une variable milieu avec une MatCell. Comme il n'y a pas de valeurs matériaux associées, cela provoquera un accès mémoire invalide qui a de fortes chance de se solder par une erreur de segmentation (SegmentationFault). Ces erreurs sont détectées en mode CHECK et il est donc préférable d'utiliser ce mode pour les développements.</dd></dl>
<h1><a class="anchor" id="arcanedoc_materials_manage_concurrency"></a>
Parallélisation des boucles sur les matériaux et milieux</h1>
<p>De la même manière que les boucles sur les entités (voir <a class="el" href="../../d0/d6b/arcanedoc_parallel_concurrency.html">Concurrence et multi-threading</a>), il est possible d'exécuter en parallèle des boucles sur les milieux où les matériaux. Cela se fait de manière similaire aux boucles sur les entités, en utilisant la méthode Parallel::Foreach. Par exemple :</p>
<div class="fragment"><div class="line">      <span class="comment">// Boucle parallèle sur les mailles du milieu env1</span></div>
<div class="line">      IMeshEnvironment* env = env1;</div>
<div class="line">      Parallel::Foreach(env-&gt;envView(),[&amp;](EnvItemVectorView view)</div>
<div class="line">        {</div>
<div class="line">          ENUMERATE_ENVCELL(ienvcell,view){</div>
<div class="line">            mat_density[ienvcell] = 2.5;</div>
<div class="line">          }</div>
<div class="line">        });</div>
<div class="line"> </div>
<div class="line">      <span class="comment">// Boucle parallèle sur les mailles du premier matériaux de env1</span></div>
<div class="line">      IMeshMaterial* mat = env1-&gt;materials()[0];</div>
<div class="line">      Parallel::Foreach(mat-&gt;matView(),[&amp;](MatItemVectorView view)</div>
<div class="line">        {</div>
<div class="line">          ENUMERATE_MATCELL(imatcell,view){</div>
<div class="line">            mat_density[imatcell] = 2.5;</div>
<div class="line">          }</div>
<div class="line">        });</div>
<div class="line"> </div>
<div class="line">      <span class="comment">// Functor générique sur un matériau ou milieu.</span></div>
<div class="line">      <span class="keyword">auto</span> func = [&amp;](ComponentItemVectorView view)</div>
<div class="line">      {</div>
<div class="line">        <a class="code hl_define" href="../../dd/df0/core_2materials_2MatItemEnumerator_8h.html#ad0a44976a632ca375796818664c67977">ENUMERATE_COMPONENTCELL</a>(iccell,view){</div>
<div class="line">          mat_density[iccell] = 2.5;</div>
<div class="line">        }</div>
<div class="line">      };</div>
<div class="line">      <span class="comment">// Application en parallèle de \a func sur le matériau</span></div>
<div class="line">      Parallel::Foreach(mat-&gt;view(),func);</div>
<div class="line">      <span class="comment">// Application en parallèle de \a func sur le milieu</span></div>
<div class="line">      Parallel::Foreach(env-&gt;view(),func);</div>
<div class="line"> </div>
<div class="line">      <span class="comment">// Application en parallèle de \a func sur le milieu avec options</span></div>
<div class="line">      ParallelLoopOptions options;</div>
<div class="line">      Parallel::Foreach(env-&gt;view(),options,func);</div>
</div><!-- fragment --><h1><a class="anchor" id="arcanedoc_materials_manage_optimization"></a>
Optimisation des modifications sur les matériaux et les milieux.</h1>
<p>La modification des mailles matériaux et milieux se fait via la classe MeshMaterialModifier. Cette modification se fait via des appels successifs à MeshMaterialModifier::addCells() ou MeshMaterialModifier::removeCells(). Ces méthodes permettent d'enregistrer la liste des modifications mais ces dernières ne sont réellement exécutées que lors de la destruction de l'instance MeshMaterialModifier.</p>
<p>Par défaut, le comportement est le suivant :</p><ul>
<li>sauvegarde des valeurs de toutes les variables matériaux</li>
<li>application des modifications (qui consiste uniquement à modifier la liste des entités des groupes de mailles associées aux matériaux et milieux)</li>
<li>restauration des valeurs de toutes les variables matériaux. Lors de la restauration, si une nouvelle maille matériau est créée, sa valeur dépend de IMeshMaterialMng::isDataInitialisationWithZero().</li>
</ul>
<p>La sauvegarde et la restauration des valeurs sont des opérations couteuses en temps CPU et mémoire. Il est possible de désactiver ces opérations via setKeepValuesAfterChange() mais bien entendu dans ce cas les valeurs partielles ne sont pas conservées.</p>
<p>Afin d'optimiser ces modifications de matériaux, il est possible de se passer de ces opérations de sauvegarde/restauration. Pour cela, il faut utiliser la méthode IMeshMaterialMng::setModificationFlags(int
v). Cette méthode doit être appelée avant IMeshMaterialMng::endCreate(). L'argument utilisé est une combinaison de bits de l'énumération eModificationFlags:</p><ul>
<li>eModificationFlags::GenericOptimize : indique qu'on souhaite activer les optimisations.</li>
<li>eModificationFlags::OptimizeMultiAddRemove: indique qu'on active les optimisations dans le cas où il y a plusieurs ajouts ou suppressions avec un même MeshMaterialModifier.</li>
<li>eModificationFlags::OptimizeMultiMaterialPerEnvironment indique qu'on active les optimisations dans le cas où il y a plusieurs matériaux dans le milieu.</li>
</ul>
<dl class="section warning"><dt>Avertissement</dt><dd>La valeur eModificationFlags::OptimizeMultiMaterialPerEnvironment n'est disponible qu'à partir de la version 2.3.2 de Arcane. Sur les versions antérieures, aucune optimisation n'est effectuée si un des matériaux modifié n'est pas le seul matériau du milieu.</dd></dl>
<p>Par exemple, on suppose les trois séries de modifications : </p><div class="fragment"><div class="line">{</div>
<div class="line">  <a class="code hl_class" href="../../d7/d7a/classArcane_1_1Materials_1_1MeshMaterialModifier.html">MeshMaterialModifier</a> <a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">m1</a>(m_material_mng);</div>
<div class="line">  <a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">m1</a>.addCells(<a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">mat1</a>,ids);</div>
<div class="line">}</div>
<div class="line">{</div>
<div class="line">  <a class="code hl_class" href="../../d7/d7a/classArcane_1_1Materials_1_1MeshMaterialModifier.html">MeshMaterialModifier</a> <a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">m2</a>(m_material_mng);</div>
<div class="line">  <a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">m2</a>.addCells(<a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">mat1</a>,<a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">ids1</a>);</div>
<div class="line">  <a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">m2</a>.addCells(<a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">mat2</a>,<a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">ids2</a>);</div>
<div class="line">  <a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">m2</a>.removeCells(<a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">mat1</a>,<a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">ids3</a>);</div>
<div class="line">}</div>
<div class="line">{</div>
<div class="line">  <a class="code hl_class" href="../../d7/d7a/classArcane_1_1Materials_1_1MeshMaterialModifier.html">MeshMaterialModifier</a> <a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">m3</a>(m_material_mng);</div>
<div class="line">  <a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">m3</a>.removeCells(<a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">mat2</a>,ids);</div>
<div class="line">}</div>
<div class="ttc" id="aclassArcane_1_1Materials_1_1MeshMaterialModifier_html"><div class="ttname"><a href="../../d7/d7a/classArcane_1_1Materials_1_1MeshMaterialModifier.html">Arcane::Materials::MeshMaterialModifier</a></div><div class="ttdoc">Objet permettant de modifier les matériaux ou les milieux.</div><div class="ttdef"><b>Definition</b> <a href="../../db/d87/MeshMaterialModifier_8h_source.html#l00044">MeshMaterialModifier.h:45</a></div></div>
</div><!-- fragment --><p>Suivant les valeurs spécifiées lors de l'init, on aura :</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">flags1</a> = (<a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">int</a>)eModificationFlags::GenericOptimize;</div>
<div class="line">m_material_mng-&gt;setModificationFlags(<a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">flags1</a>);</div>
<div class="line"><span class="comment">// Seuls m1 et m3 sont optimisés.</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">flags2</a> = (<a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">int</a>)eModificationFlags::GenericOptimize | (<span class="keywordtype">int</span>)eModificationFlags::OptimizeMultiAddRemove;</div>
<div class="line">m_material_mng-&gt;setModificationFlags(<a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">flags2</a>);</div>
<div class="line"><span class="comment">// m1, m2 et m3 sont optimisés.</span></div>
</div><!-- fragment --><p>Il est possible de surcharger les optimisations utilisées via la variable d'environnement ARCANE_MATERIAL_MODIFICATION_FLAGS. Cette variable doit contenir une valeur entière correspondant à celle utilisée en argument de IMeshMaterialMng::setModificationFlags() (à savoir 1 pour l'optimisation générale, 3 pour en plus optimiser les ajouts/suppressions multiples, et 7 pour optimiser aussi les cas des milieux multi-matériaux).</p>
<h2><a class="anchor" id="arcanedoc_materials_manage_optimization_implementation"></a>
Notes sur l'implémentation</h2>
<p> 
<span style='background: red'>IMPORTANT</span>
</p>
<h4>NOTE 1</h4>
<p>Actuellement, les méthodes optimisées ne réutilisent pas les valeurs partielles lorsque des mailles sont supprimées puis ajoutées à un même matériau ce qui conduit à une augmentation progressive de la mémoire utilisée par les valeurs partielles. Il est néanmoins possible de libérer cette mémoire supplémentaire via l'appel à IMeshMaterialMng::forceRecompute().</p>
<h4>NOTE 2</h4>
<p>Le comportement en mode optimisé lorsqu'il y a suppression puis ajout d'une même maille dans un même matériau est différent du mode classique. Par exemple :</p>
<div class="fragment"><div class="line"><a class="code hl_class" href="../../d7/d7a/classArcane_1_1Materials_1_1MeshMaterialModifier.html">MeshMaterialModifier</a> <a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">m1</a>(m_material_mng);</div>
<div class="line"><a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">Array&lt;Int32&gt;</a> <a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">add_ids</a>;</div>
<div class="line"><a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">Array&lt;Int32&gt;</a> <a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">remove_ids</a>;</div>
<div class="line"> </div>
<div class="line"><a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">remove_ids</a>.add(5);</div>
<div class="line"><a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">remove_ids</a>.add(9);</div>
<div class="line"><a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">add_ids</a>.add(5);</div>
<div class="line"><a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">add_ids</a>.add(7);</div>
<div class="line"> </div>
<div class="line"><a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">m1</a>.removeCells(<a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">mat1</a>,<a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">remove_ids</a>);</div>
<div class="line"><a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">m1</a>.addCells(<a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">mat1</a>,<a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">add_ids</a>);</div>
</div><!-- fragment --><p>La maille de localId() <em>5</em> est d'abord supprimée puis remise dans le matériau. En mode classique, la valeur de la maille sera la même qu'avant la modification car on restaure la valeur depuis la sauvegarde. En mode optimisé, avec eModificationFlags::OptimizeMultiAddRemove spécifié, on supprime d'abord la maille du matériau puis on l'a recréé. Sa valeur sera donc celle d'une nouvelle maille matériau crée, donc 0 si IMeshMaterialMng::isDataInitialisationWithZero() ou la valeur de la maille globale associée sinon.</p>
<h4>NOTE 3</h4>
<p>Enfin, les méthodes optimisées sont plus strictes que les méthodes classiques et certaines opérations qui étaient tolérées en mode classique ne le sont plus :</p><ul>
<li>spécifier dans la liste des mailles à ajouter une maille qui est déjà dans le matériau.</li>
<li>spécifier dans la liste des mailles à supprimer une maille qui n'est pas dans le matériau.</li>
<li>spécifier plusieurs fois la même maille dans la liste des mailles à supprimer ou ajouter.</li>
</ul>
<div class="fragment"><div class="line"><a class="code hl_class" href="../../d7/d7a/classArcane_1_1Materials_1_1MeshMaterialModifier.html">MeshMaterialModifier</a> <a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">mm</a>(m_material_mng);</div>
<div class="line"><a class="code hl_class" href="../../d9/d09/classArccore_1_1Array.html">Int32Array</a> ids;</div>
<div class="line">ids.add(5);</div>
<div class="line"><a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">mm</a>.addCells(<a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">mat1</a>,ids); <span class="comment">// Erreur si la maille 5 est déjà dans mat1</span></div>
<div class="line"><a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">mm</a>.removeCells(<a class="code hl_class" href="../../db/d19/classArcane_1_1ScopedPtrT.html">mat1</a>,ids); <span class="comment">// Erreur si la maille 5 n&#39;est pas mat1</span></div>
<div class="line">ids.add(6);</div>
<div class="line">ids.add(6); <span class="comment">// Erreur si \a ids contient plusieurs fois la même maille.</span></div>
<div class="ttc" id="aclassArccore_1_1Array_html"><div class="ttname"><a href="../../d9/d09/classArccore_1_1Array.html">Arccore::Array</a></div><div class="ttdoc">Classe de base des vecteurs 1D de données.</div><div class="ttdef"><b>Definition</b> <a href="../../da/d85/arccore_2src_2collections_2arccore_2collections_2Array_8h_source.html#l00970">arccore/src/collections/arccore/collections/Array.h:972</a></div></div>
</div><!-- fragment --><p>Si on se trouve dans un des cas précédent, il y a de fortes chances que cela fasse planter le code. Pour éviter cela, le mode CHECK détecte ces erreurs, les signale dans le listing et les filtre pour que cela fonctionne correctement. Ces erreurs sont signalées dans le listing par des messages du style suivant :</p>
<pre class="fragment">ERROR: item ... is present several times in add/remove list for material mat=...
ERROR: item ... is already in material mat=...
ERROR: item ... is not in material mat=...
</pre><p>En mode release, la détection et la correction ne se fait que si la variable d'environnement ARCANE_CHECK est positionnée et vaut 1. */</p>
<hr  />
<div class="section_buttons"> <span class="back_section_button"> <a class="el" href="../../d8/d69/arcanedoc_materials.html">Matériaux et milieux</a> </span> <span class="next_section_button"> <a class="el" href="../../d9/d76/arcanedoc_materials_loop.html">Boucles sur les entités des matériaux et des milieux</a> </span> </div> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.5-->
<!-- start footer part -->
  <div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
    <ul>
      <li class="navelem"><a class="el" href="../../index.html">%Arcane</a></li><li class="navelem"><a class="el" href="../../d8/d69/arcanedoc_materials.html">Matériaux et milieux</a></li>
      <li class="footer">Généré le Lundi 20 Mai 2024 02:24:58 pour Arcane par <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
    </ul>
  </div>
  <script type="text/javascript" src="../../script-apply-config-theme.js"></script>
  <script type="text/javascript">
    // On met l'appel à cette fonction dans le footer dans le cas où
    // une page ne veut pas de personnalisation (changement de la 
    // variable globale "no_custom_theme").
    applyConfigWithCookies();
  </script>
</body>
</html>
