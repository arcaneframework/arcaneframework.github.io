<!-- HTML header for doxygen 1.9.5-->
<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=11" />
    <meta name="generator" content="Doxygen 1.9.6" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Arcane: Intégration avec CUPTI (Cuda Profiling Tools Interface)</title>
    <link href="../../tabs.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="../../jquery.js"></script>
    <script type="text/javascript" src="../../dynsections.js"></script>
    <link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
    <link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript">
window.MathJax = {
  options: {
    ignoreHtmlClass: 'tex2jax_ignore',
    processHtmlClass: 'tex2jax_process'
  }
};
</script>
<script type="text/javascript" id="MathJax-script" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    <link href="../../doxygen.css" rel="stylesheet" type="text/css" />
    <link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-custom.css" rel="stylesheet" type="text/css"/>
<link href="../../custom.css" rel="stylesheet" type="text/css"/>
<link href="../../user_colors.css" rel="stylesheet" type="text/css"/>
    <script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
    <script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
    <script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
    <script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
    <script type="text/javascript" src="../../doxygen-awesome-tabs.js"></script>
    <script type="text/javascript" src="../../script-helper.js"></script>
    <script type="text/javascript" src="../../script-resize.js"></script>
    <script type="text/javascript" src="../../script-num-lines-code.js"></script>
    <script type="text/javascript" src="../../script-config-theme.js"></script>
    <script type="text/javascript" src="../../script-edit-config-theme.js"></script>
    <script type="text/javascript" src="../../script-alternative-theme.js"></script>
    <script type="text/javascript">
      // On demande l'activation de la personnalisation de la page.
      var no_custom_theme = false;
      DoxygenAwesomeDarkModeToggle.title = "Thème clair/sombre";
      DoxygenAwesomeDarkModeToggle.init();
      DoxygenAwesomeFragmentCopyButton.title = "Copier le code dans le presse-papier";
      DoxygenAwesomeFragmentCopyButton.init();
      DoxygenAwesomeParagraphLink.init();
      DoxygenAwesomeInteractiveToc.init();
      DoxygenAwesomeTabs.init()
      waitElemForResizeSideNav();
      setOldSize();
      //waitItemExpandCurrent();
    </script>
  </head>
  <body>
    <!--BEGIN CORNER_GITHUB-->
    <!-- https://tholman.com/github-corners/ -->
    <a href="https://github.com/arcaneframework/framework" class="github-corner" aria-label="Voir les sources sur GitHub">
      <svg width="70" height="70" viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path
          d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
          fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path
          d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
          fill="currentColor" class="octo-body"></path>
      </svg>
    </a>
    <!--END CORNER_GITHUB-->
      <div id="top">
        <!-- do not remove this div, it is closed by doxygen! -->
        <div id="titlearea">
          <table cellspacing="0" cellpadding="0">
            <tbody>
              <tr id="projectrow">
                <td id="projectlogo">
                  <a href="../../index.html" title="Aller à la page principale">
                    <img alt="Logo" src="../../arcane_logo.webp" />
                  </a>
                </td>
              </tr>
              <tr id="projectrow">
                <td id="projectalign">
                  <div id="projectname">Arcane
                    <span id="projectnumber">&#160;v3.12.9.0</span>
                  </div>
                  <div id="projectbrief">Documentation utilisateur</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- end header part --><!-- Généré par Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Recherche');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d8/dcd/arcanedoc_debug_perf_cupti.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Chargement...</div>
<div class="SRStatus" id="Searching">Recherche...</div>
<div class="SRStatus" id="NoMatches">Aucune correspondance</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Intégration avec CUPTI (Cuda Profiling Tools Interface) </div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table des matières</h3>
<ul><li class="level1"><a href="#autotoc_md86">Description</a></li>
<li class="level1"><a href="#autotoc_md89">Exemple</a></li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md_doc_doc_user_chap_debug_perf_5_cupti"></a></p>
<h1><a class="anchor" id="autotoc_md86"></a>
Description</h1>
<p><a href="https://docs.nvidia.com/cupti/index.html">CUPTI</a> est une bibliothèque fournie par NVIDIA. Elle permet entre autre de récupérer des évènements concernant la gestion de la mémoire unifiée. C'est dans ce contexte qu'Arcane utilise CUPTI.</p>
<p>L'utilisation de CUPTI se fait via des variables d'environnement</p>
<table class="doxtable">
<tr>
<th>Variable d'environnement</th><th><p class="starttd">Description</p>
<p class="endtd"></p>
</th></tr>
<tr>
<td>ARCANE_CUPTI_LEVEL </td><td><p class="starttd">Indique les évènements qu'on veut tracer. A noter que pour le niveau 2 il faut un accès exclusif au GPU et donc ce mode ne fonctionne pas en parallèle. Les valeurs possibles sont:</p><ul>
<li>0 non actif</li>
<li>1 transferts mémoire unifiée</li>
<li>2 idem 1 + noyaux de calcul  </li>
</ul>
<p class="endtd"></p>
</td></tr>
<tr>
<td>ARCANE_CUPTI_FLUSH </td><td><p class="starttd">Indique à quel moment on affiche les informations sur les évènements. Pour avoir un suivi précis il est nécessaire d'afficher les informations après chaque exécution de noyau GPU mais ce mode peut augmenter d'une facteur important le temps d'exécution. Les valeurs possibles sont:</p><ul>
<li>0 pas de flush explicite</li>
<li>1 flush après chaque noyau  </li>
</ul>
<p class="endtd"></p>
</td></tr>
<tr>
<td>ARCANE_CUPTI_PRINT </td><td><p class="starttd">Indique si on souhaite effectuer un affichage pour chaque évènement. Cela peut ralentir considérablement le temps d'exécution. Les valeurs possibles sont:</p><ul>
<li>0 pas d’affichage</li>
<li>1 affichage listing (sur std::cout)  </li>
</ul>
<p class="endtd"></p>
</td></tr>
<tr>
<td>ARCANE_CUDA_MALLOC_TRACE </td><td><p class="starttd">Indique si on souhaite tracer tous les appels à <code>cudaMallocManaged()</code>. Les valeurs possibles sont:</p><ul>
<li>0 pas de trace</li>
<li>1 trace le nom du tableau</li>
<li>2 idem 1 + affichage des malloc et des free</li>
<li>3 idem 2 + pile d’appel  </li>
</ul>
<p class="endtd"></p>
</td></tr>
<tr>
<td>ARCANE_CUDA_UM_PAGE_ALLOC </td><td><p class="starttd">Indique la manière d'allouer via <code>cudaMallocManaged()</code>. Il est possible pour chaque allocation d'allouer un multiple de la taille d'une page mémoire. Comme les transferts de la mémoire unifiée se font page par page, cela permet de mieux distinguer quel accès mémoire a provoqué le transfert. La contrepartie est que chaque allocation nécessite d'allouer au moins une page (soit 4Ko en général) Les valeurs possibles sont:</p><ul>
<li>0 allocation normale</li>
<li>1 allocation par multiple de la taille d'une page.  </li>
</ul>
<p class="endtd"></p>
</td></tr>
</table>
<h1><a class="anchor" id="autotoc_md89"></a>
Exemple</h1>
<p>L'exemple suivant permet de tracer les transferts en mémoire unifiée et d'afficher le nom du tableau associé.</p>
<div class="fragment"><div class="line">ARCANE_CUDA_MALLOC_TRACE=1 ARCANE_CUPTI_FLUSH=1 ARCANE_CUPTI_LEVEL=1 ./my_test -A,AcceleratorRuntime=cuda toto.arc</div>
</div><!-- fragment --><p>Avec le résultat suivant</p>
<div class="fragment"><div class="line">*I-ArcaneMasterInternal *** ITERATION       17  TIME 3.594972986357219e-03  LOOP       17  DELTAT 4.177248169415655e-04 ***</div>
<div class="line">*I-ArcaneMasterInternal Date: 2023-10-26T09:40:35 Conso=(R=2.168,I=0.131,C=0.166) Mem=(222,m=222:0,M=222:0,avg=222)</div>
<div class="line">UNIFIED_MEMORY_COUNTER [ 4179074172 4179078748 ] address=0x7f1cc01f9000 kind=BYTES_TRANSFER_HTOD value=24576 flags=3 source=0 destination=0 name=Mesh0_TimeHistoryGlobalTime stack=</div>
<div class="line">UNIFIED_MEMORY_COUNTER [ 4179078748 4179081788 ] address=0x7f1cc01ff000 kind=BYTES_TRANSFER_HTOD value=4096 flags=2 source=0 destination=0 name=Mesh0_TimeHistoryGlobalTime stack=</div>
<div class="line">UNIFIED_MEMORY_COUNTER [ 4179241052 4179244924 ] address=0x7f1cc01f9000 kind=BYTES_TRANSFER_DTOH value=24576 flags=3 source=0 destination=0 name=Mesh0_TimeHistoryGlobalTime stack=</div>
<div class="line">UNIFIED_MEMORY_COUNTER [ 4179244924 4179246172 ] address=0x7f1cc01ff000 kind=BYTES_TRANSFER_DTOH value=4096 flags=2 source=0 destination=0 name=Mesh0_TimeHistoryGlobalTime stack=</div>
<div class="line">UNIFIED_MEMORY_COUNTER [ 4223957312 4223960384 ] address=0x7f1cc0bff000 kind=BYTES_TRANSFER_HTOD value=4096 flags=2 source=0 destination=0 name=Mesh0_TimeHistory_Iterations_1 stack=</div>
<div class="line">*I-ArcaneMasterInternal  </div>
<div class="line">*I-ArcaneMasterInternal *** ITERATION       18  TIME 4.054470284992941e-03  LOOP       18  DELTAT 4.594972986357221e-04 ***</div>
<div class="line">*I-ArcaneMasterInternal Date: 2023-10-26T09:40:35 Conso=(R=2.299,I=0.131,C=0.176) Mem=(222,m=222:0,M=222:0,avg=222)</div>
<div class="line">UNIFIED_MEMORY_COUNTER [ 4353892054 4353895094 ] address=0x7f1cc0bff000 kind=BYTES_TRANSFER_HTOD value=4096 flags=2 source=0 destination=0 name=Mesh0_TimeHistory_Iterations_1 stack=</div>
</div><!-- fragment --><p>Les deux valeurs après <code>UNIFIED_MEMORY_COUNTER</code> correspondent au temps de début et de fin du tranfert. Les autres champs sont:</p><ul>
<li><code>address</code> : adresse mémoire du tableau</li>
<li><code>kind</code> : type de tranfert (<code>Host to device</code> ou <code>Device to host</code>)</li>
<li><code>value</code>: quantité (en octet) de mémoire tranférée</li>
<li><code>flags</code> : si <code>2</code> alors le tranfert est explicitement demandé par le code. Si <code>3</code>, il s'agit d'un tranfert spéculatif initié par le driver NVIDIA.</li>
<li><code>source</code> et <code>destination</code> : numéro du device</li>
<li><code>name</code> : nom du tableau <a class="el" href="../../d0/d32/namespaceArcane.html" title="-*- tab-width: 2; indent-tabs-mode: nil; coding: utf-8-with-signature -*-">Arcane</a>. Cela n'est actif que si la variable d'environnement <code>ARCANE_CUDA_MALLOC_TRACE</code> vaut au moins 1. Si le transfert n'est pas lié à un tableau Arcane (<a class="el" href="../../da/daa/classArccore_1_1UniqueArray.html">UniqueArray</a> ou <a class="el" href="../../d9/d8e/classArcane_1_1NumArray.html">NumArray</a>), il n'y aura pas de nom associé. A noter que comme les transferts se font page par page, il est possible que le tableau indiqué ne soit pas celui qui a provoqué le transfert. Pour éviter cet effet, il est possible d'allouer une page pour chaque allocation en positionnant la variable d'environnement <code>ARCANE_CUDA_UM_PAGE_ALLOC</code> à <code>1</code>.</li>
</ul>
<p>En fin de calcul est affiché la quantité totale de mémoire transférée et le nombre de transferts. Par exemple:</p>
<div class="fragment"><div class="line">MemoryTransferSTATS: HTOD = 17895424 (680) DTOH = 7102464 (301)</div>
</div><!-- fragment --><p>Dans cet exemple, on a fait 680 transferts du CPU vers le GPU pour 17Mo de données transférées. On a fait 301 transferts du GPU vers le CPU pour 7Mo de données transférées.</p>
<hr  />
<div class="section_buttons"> <span class="back_section_button"> <a class="el" href="../../d6/dc6/arcanedoc_debug_perf_unit_tests.html">Le support des tests unitaires dans Arcane</a> </span> <span class="next_section_button"> <a class="el" href="../../dd/d47/arcanedoc_debug_perf_profiling.html">Profiling</a> </span> </div> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.5-->
<!-- start footer part -->
  <div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
    <ul>
      <li class="navelem"><a class="el" href="../../index.html">%Arcane</a></li><li class="navelem"><a class="el" href="../../da/dc1/arcanedoc_debug_perf.html">Debug, performance et validation</a></li>
      <li class="footer">Généré le Lundi 11 Mars 2024 02:14:46 pour Arcane par <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6 </li>
    </ul>
  </div>
  <script type="text/javascript" src="../../script-apply-config-theme.js"></script>
  <script type="text/javascript">
    // On met l'appel à cette fonction dans le footer dans le cas où
    // une page ne veut pas de personnalisation (changement de la 
    // variable globale "no_custom_theme").
    applyConfigWithCookies();
  </script>
</body>
</html>
