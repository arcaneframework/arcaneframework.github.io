<!-- HTML header for doxygen 1.9.5-->
<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=11" />
    <meta name="generator" content="Doxygen 1.9.8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="../../logo_arcane.svg" type="image/svg+xml">
    <title>Arcane: Vectorisation</title>
    <link href="../../tabs.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="../../jquery.js"></script>
    <script type="text/javascript" src="../../dynsections.js"></script>
    <link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
    <link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript">
window.MathJax = {
  options: {
    ignoreHtmlClass: 'tex2jax_ignore',
    processHtmlClass: 'tex2jax_process'
  }
};
</script>
<script type="text/javascript" id="MathJax-script" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    <link href="../../doxygen.css" rel="stylesheet" type="text/css" />
    <link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-custom.css" rel="stylesheet" type="text/css"/>
<link href="../../custom.css" rel="stylesheet" type="text/css"/>
<link href="../../user_colors.css" rel="stylesheet" type="text/css"/>
    <script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
    <script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
    <script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
    <script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
    <script type="text/javascript" src="../../doxygen-awesome-tabs.js"></script>
    <script type="text/javascript" src="../../script-helper.js"></script>
    <script type="text/javascript" src="../../script-resize.js"></script>
    <script type="text/javascript" src="../../script-num-lines-code.js"></script>
    <script type="text/javascript" src="../../script-config-theme.js"></script>
    <script type="text/javascript" src="../../script-edit-config-theme.js"></script>
    <script type="text/javascript" src="../../script-alternative-theme.js"></script>
    <script type="text/javascript">
      // On demande l'activation de la personnalisation de la page.
      var no_custom_theme = false;
      DoxygenAwesomeDarkModeToggle.title = "Thème clair/sombre";
      DoxygenAwesomeDarkModeToggle.init();
      DoxygenAwesomeFragmentCopyButton.title = "Copier le code dans le presse-papier";
      DoxygenAwesomeFragmentCopyButton.init();
      DoxygenAwesomeParagraphLink.init();
      DoxygenAwesomeInteractiveToc.init();
      DoxygenAwesomeTabs.init()
      waitElemForResizeSideNav();
      setOldSize();
      //waitItemExpandCurrent();
    </script>
  </head>
  <body>
    <!--BEGIN CORNER_GITHUB-->
    <!-- https://tholman.com/github-corners/ -->
    <a href="https://github.com/arcaneframework/framework" class="github-corner" aria-label="Voir les sources sur GitHub">
      <svg width="70" height="70" viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path
          d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
          fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path
          d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
          fill="currentColor" class="octo-body"></path>
      </svg>
    </a>
    <!--END CORNER_GITHUB-->
      <div id="top">
        <!-- do not remove this div, it is closed by doxygen! -->
        <div id="titlearea">
          <table cellspacing="0" cellpadding="0">
            <tbody>
              <tr id="projectrow">
                <td id="projectlogo">
                  <a href="../../index.html" title="Aller à la page principale">
                    <img alt="Logo" src="../../arcane_framework_small.webp" />
                  </a>
                </td>
              </tr>
              <tr id="projectrow">
                <td id="projectalign">
                  <div id="projectname">Arcane
                    <span id="projectnumber">&#160;v3.14.0.0</span>
                  </div>
                  <div id="projectbrief">Documentation utilisateur</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- end header part -->
<!-- Généré par Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Recherche');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('db/d95/arcanedoc_parallel_simd.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Chargement...</div>
<div class="SRStatus" id="Searching">Recherche...</div>
<div class="SRStatus" id="NoMatches">Aucune correspondance</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Vectorisation</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table des matières</h3>
<ul><li class="level1"><a href="#arcanedoc_parallel_simd_intro">Introduction</a></li>
<li class="level1"><a href="#arcanedoc_parallel_simd_usage">Utilisation des classes vectorielles</a></li>
<li class="level1"><a href="#arcanedoc_parallel_simd_alignment">Gestion de l&#39;alignement</a></li>
<li class="level1"><a href="#arcanedoc_parallel_simd_endloop">Gestion des fins de boucle</a></li>
<li class="level1"><a href="#arcanedoc_parallel_simd_operation">Opérations supportées</a></li>
<li class="level1"><a href="#arcanedoc_parallel_simd_support">Mécanismes de vectorisation supportés</a></li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="arcanedoc_parallel_simd_intro"></a>
Introduction</h1>
<p>La vectorisation est un mécanisme permettant d'exécuter la même instruction sur plusieurs données. Le terme anglais couramment utilisé pour qualifier la vectorisation est <b>Single Instruction Multiple Data (SIMD)</b>. Comme il s'agit d'une instruction gérée directement par le processeur, les opérations possibles sont assez limitées. En général, il s'agit des opérations arithmétiques de base (addition, soustraction, ...) ainsi que les fonctions mathématiques classiques (minimum, maximum, valeur absolue, ...). Les opérations mathématiques complexes (comme le logarithme, l'exponentielle, ...) ne sont en général pas des instructions natives vectorielles.</p>
<p>Les processeurs récents permettent tous de faire de la vectorisation. Par contre, les tailles de vecteur et les opérations possibles sont différentes d'un processeur à l'autre.</p>
<p>Par exemple, la boucle simple suivante effectue <b>n</b> additions :</p>
<div class="fragment"><div class="line"><span class="keyword">using namespace </span><a class="code hl_namespace" href="../../d0/d32/namespaceArcane.html">Arcane</a>;</div>
<div class="line"><a class="code hl_class" href="../../da/daa/classArccore_1_1UniqueArray.html">UniqueArray&lt;Real&gt;</a> a, b, c;</div>
<div class="line"><span class="keywordflow">for</span>( <span class="keywordtype">int</span> i=0; i&lt;n; ++i ){</div>
<div class="line">  a[i] = b[i] + c[i];</div>
<div class="line">}</div>
<div class="ttc" id="aclassArccore_1_1UniqueArray_html"><div class="ttname"><a href="../../da/daa/classArccore_1_1UniqueArray.html">Arccore::UniqueArray</a></div><div class="ttdoc">Vecteur 1D de données avec sémantique par valeur (style STL).</div><div class="ttdef"><b>Definition</b> <a href="../../da/d85/arccore_2src_2collections_2arccore_2collections_2Array_8h_source.html#l01741">arccore/src/collections/arccore/collections/Array.h:1743</a></div></div>
<div class="ttc" id="anamespaceArcane_html"><div class="ttname"><a href="../../d0/d32/namespaceArcane.html">Arcane</a></div><div class="ttdoc">-*- tab-width: 2; indent-tabs-mode: nil; coding: utf-8-with-signature -*-</div><div class="ttdef"><b>Definition</b> <a href="../../de/df4/AbstractCaseDocumentVisitor_8cc_source.html#l00020">AbstractCaseDocumentVisitor.cc:20</a></div></div>
</div><!-- fragment --><p>Avec un processeur scalaire, les registres ne contiennent qu'un seul réel et les instructions d'addition opèrent donc sur un seul réel. Il faudra <b>n</b> instructions d'addition pour faire ce calcul. Un processeur vectoriel dispose de registres contenant plusieurs réels. Pour des registres contenant <b>P</b> réels, le nombre d'instructions d'addition nécessaire est donc <b>n/P</b>. Si les instructions scalaires et vectorielles prennent le même temps, on a donc une accélération théorique d'un facteur <b>P</b>. Plus les registres sont grands, plus l'intéret potentiel de la vectorisation est important. Bien entendu, dans la pratique c'est souvent moins rose et le gain réel dépend d'autres facteurs comme la bande passante mémoire, le pipelining, ...</p>
<p>Pour exploiter la vectorisation, il existe deux possibilités (qui sont compatibles) :</p>
<ul>
<li>laisser le compilateur gérer la vectorisation.</li>
<li>utiliser des classes C++ spécifiques conçues pour cela.</li>
</ul>
<p>La première solution est la plus simple car elle ne nécessite pas de changer le code. Elle est directement disponible via les bonnes options du compilateur. La contrepartie de cette simplicité est qu'il est souvent difficile pour le compilateur de détecter les endroits où la vectorisation est possible. Le code généré est donc rarement vectorisé. La seconde méthode garantit l'exploitation de la vectorisation mais elle nécessite de réécrire le code. Arcane propose un ensemble de classes pour exploiter cette seconde méthode.</p>
<p>Le principe est donc de fournir une classe vectorielle correspondant à une classe scalaire. La classe vectorielle contiendra donc <em>N</em> valeurs scalaires, avec <em>N</em> dépendant du type de vectorisation disponible.</p>
<p>Même si en théorie la vectorisation peut s'appliquer sur tous les types simples (short, int, long, float, ...), on se limite dans Arcane à fournir des classes gérant la vectorisation que pour les types Arcane::Real et dérivés (<a class="el" href="../../d6/d24/classArcane_1_1Real2.html" title="Classe gérant un vecteur de réel de dimension 2.">Arcane::Real2</a>, <a class="el" href="../../d1/da6/classArcane_1_1Real3.html" title="Classe gérant un vecteur de réel de dimension 3.">Arcane::Real3</a>).</p>
<p>Actuellement, Arcane fournit les types vectoriels suivants :</p>
<table class="doxtable">
<tr>
<th>Type scalaire </th><th>Type vectoriel </th><th>Fichier de définition  </th></tr>
<tr>
<td>Arcane::Real </td><td><a class="el" href="../../d5/d04/group__ArcaneSimd.html#ga5aa9d2a778e46ece234ee1dbf469a04e" title="Vecteur SIMD de réel.">Arcane::SimdReal</a> </td><td><p class="starttd"></p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d6/dea/Simd_8h.html">arcane/utils/Simd.h</a>&quot;</span></div>
<div class="ttc" id="aSimd_8h_html"><div class="ttname"><a href="../../d6/dea/Simd_8h.html">Simd.h</a></div></div>
</div><!-- fragment -->  </td></tr>
<tr>
<td><a class="el" href="../../d6/d24/classArcane_1_1Real2.html" title="Classe gérant un vecteur de réel de dimension 2.">Arcane::Real2</a> </td><td><a class="el" href="../../d4/d7a/classArcane_1_1SimdReal2.html" title="Représente un Real2 vectoriel.">Arcane::SimdReal2</a> </td><td></td></tr>
<tr>
<td><a class="el" href="../../d1/da6/classArcane_1_1Real3.html" title="Classe gérant un vecteur de réel de dimension 3.">Arcane::Real3</a> </td><td><a class="el" href="../../d2/d63/classArcane_1_1SimdReal3.html" title="Représente un Real3 vectoriel.">Arcane::SimdReal3</a> </td><td></td></tr>
<tr>
<td><a class="el" href="../../df/d5f/classArcane_1_1Item.html" title="Classe de base d&#39;un élément de maillage.">Arcane::Item</a>, <a class="el" href="../../d9/db2/classArcane_1_1Cell.html" title="Maille d&#39;un maillage.">Arcane::Cell</a>, <a class="el" href="../../d1/db1/classArcane_1_1Face.html" title="Face d&#39;une maille.">Arcane::Face</a>, ... </td><td><a class="el" href="../../d5/d75/classArcane_1_1SimdItem.html" title="Gère un vecteur d&#39;entité Item.">Arcane::SimdItem</a>, <a class="el" href="../../d5/d04/group__ArcaneSimd.html#ga1fa29db17212b77758a93b80957fe001" title="Vecteur SIMD de Cell.">Arcane::SimdCell</a>, <a class="el" href="../../d5/d04/group__ArcaneSimd.html#ga96c9290f4544f880ad7a710b6226f36d" title="Vecteur SIMD de Face.">Arcane::SimdFace</a>, ... </td><td><p class="starttd"></p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;arcane/SimdItem.h&quot;</span></div>
</div><!-- fragment -->   </td></tr>
</table>
<dl class="section note"><dt>Note</dt><dd>Pour l'instant, les classes Real2x2 et Real3x3 ne disposent pas d'une classe vectorielle associée mais cela sera disponible dans une version ultérieure de Arcane.</dd></dl>
<h1><a class="anchor" id="arcanedoc_parallel_simd_usage"></a>
Utilisation des classes vectorielles</h1>
<p>L'utilisation des classes SIMD est similaire à l'usage scalaire. Il suffit en général de changer le nom des classes scalaires par le nom vectoriel correspondant.</p>
<dl class="section note"><dt>Note</dt><dd>L'utilisation de la vectorisation suppose l'utilisation des vues sur les variables. Il n'est pas possible d'accéder directement à une variable via les classes <a class="el" href="../../d5/d75/classArcane_1_1SimdItem.html" title="Gère un vecteur d&#39;entité Item.">Arcane::SimdItem</a> et dérivées.</dd></dl>
<p>L'exemple suivant montre comment passer d'une écriture scalaire à une écriture vectorielle :</p>
<div class="fragment"><div class="line"><span class="keyword">using namespace </span><a class="code hl_namespace" href="../../d0/d32/namespaceArcane.html">Arcane</a>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Déclaration des variables</span></div>
<div class="line"><a class="code hl_class" href="../../d7/d20/classArcane_1_1MeshVariableScalarRefT.html">VariableCellReal</a> pressure = ...;</div>
<div class="line"><a class="code hl_class" href="../../d7/d20/classArcane_1_1MeshVariableScalarRefT.html">VariableCellReal</a> density = ...;</div>
<div class="line"><a class="code hl_class" href="../../d7/d20/classArcane_1_1MeshVariableScalarRefT.html">VariableCellReal</a> adiabatic_cst = ...;</div>
<div class="line"><a class="code hl_class" href="../../d7/d20/classArcane_1_1MeshVariableScalarRefT.html">VariableCellReal</a> internal_energy = ...;</div>
<div class="line"><a class="code hl_class" href="../../d7/d20/classArcane_1_1MeshVariableScalarRefT.html">VariableCellReal</a> sound_speed = ...;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Vues en entrée (lecture)</span></div>
<div class="line"><span class="comment">// En C++11, il est aussi possible d&#39;utiliser le mot clé &#39;auto&#39;:</span></div>
<div class="line"><span class="comment">// auto in_pressure = viewIn(pressure);</span></div>
<div class="line">VariableCellRealInView in_pressure = viewIn(pressure);</div>
<div class="line">VariableCellRealInView in_density = viewIn(m_density);</div>
<div class="line">VariableCellRealInView in_adiabatic_cst = viewIn(adiabatic_cst);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Vues en sortie (écriture)</span></div>
<div class="line">VariableCellRealOutView out_internal_energy = viewOut(internal_energy);</div>
<div class="line">VariableCellRealOutView out_sound_speed = viewOut(sound_speed);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Version scalaire</span></div>
<div class="line"><a class="code hl_define" href="../../d6/d0f/ItemEnumerator_8h.html#aaf5910d68ad8428248f844535ab071f3">ENUMERATE_CELL</a>(icell,allCells()){</div>
<div class="line">  <a class="code hl_class" href="../../d9/db2/classArcane_1_1Cell.html">Cell</a> vi = *icell;</div>
<div class="line">  Real pressure = in_pressure[vi];</div>
<div class="line">  Real adiabatic_cst = in_adiabatic_cst[vi];</div>
<div class="line">  Real density = in_density[vi];</div>
<div class="line">  out_internal_energy[vi] = pressure / ((adiabatic_cst-1.0) * density);</div>
<div class="line">  out_sound_speed[vi] = math::sqrt(adiabatic_cst*pressure/density);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Version vectorielle</span></div>
<div class="line"><a class="code hl_define" href="../../d5/d04/group__ArcaneSimd.html#ga0a9dc0b44f6c0935eefd6947014c937f">ENUMERATE_SIMD_CELL</a>(icell,allCells()){</div>
<div class="line">  <a class="code hl_typedef" href="../../d5/d04/group__ArcaneSimd.html#ga1fa29db17212b77758a93b80957fe001">SimdCell</a> vi = *icell;</div>
<div class="line">  <a class="code hl_class" href="../../d7/dc2/classArcane_1_1EMULSimdReal.html">SimdReal</a> pressure = in_pressure[vi];</div>
<div class="line">  <a class="code hl_class" href="../../d7/dc2/classArcane_1_1EMULSimdReal.html">SimdReal</a> adiabatic_cst = in_adiabatic_cst[vi];</div>
<div class="line">  <a class="code hl_class" href="../../d7/dc2/classArcane_1_1EMULSimdReal.html">SimdReal</a> density = in_density[vi];</div>
<div class="line">  out_internal_energy[vi] = pressure / ((adiabatic_cst-1.0) * density);</div>
<div class="line">  out_sound_speed[vi] = math::sqrt(adiabatic_cst*pressure/density);</div>
<div class="line">}</div>
<div class="ttc" id="aItemEnumerator_8h_html_aaf5910d68ad8428248f844535ab071f3"><div class="ttname"><a href="../../d6/d0f/ItemEnumerator_8h.html#aaf5910d68ad8428248f844535ab071f3">ENUMERATE_CELL</a></div><div class="ttdeci">#define ENUMERATE_CELL(name, group)</div><div class="ttdoc">Enumérateur générique d'un groupe de mailles.</div><div class="ttdef"><b>Definition</b> <a href="../../d6/d0f/ItemEnumerator_8h_source.html#l00427">ItemEnumerator.h:427</a></div></div>
<div class="ttc" id="aclassArcane_1_1Cell_html"><div class="ttname"><a href="../../d9/db2/classArcane_1_1Cell.html">Arcane::Cell</a></div><div class="ttdoc">Maille d'un maillage.</div><div class="ttdef"><b>Definition</b> <a href="../../d1/dd4/Item_8h_source.html#l01171">Item.h:1173</a></div></div>
<div class="ttc" id="aclassArcane_1_1EMULSimdReal_html"><div class="ttname"><a href="../../d7/dc2/classArcane_1_1EMULSimdReal.html">Arcane::EMULSimdReal</a></div><div class="ttdoc">Vectorisation des réels par émulation.</div><div class="ttdef"><b>Definition</b> <a href="../../d0/d52/SimdEMUL_8h_source.html#l00154">SimdEMUL.h:155</a></div></div>
<div class="ttc" id="aclassArcane_1_1MeshVariableScalarRefT_html"><div class="ttname"><a href="../../d7/d20/classArcane_1_1MeshVariableScalarRefT.html">Arcane::MeshVariableScalarRefT&lt; Cell, Real &gt;</a></div></div>
<div class="ttc" id="agroup__ArcaneSimd_html_ga0a9dc0b44f6c0935eefd6947014c937f"><div class="ttname"><a href="../../d5/d04/group__ArcaneSimd.html#ga0a9dc0b44f6c0935eefd6947014c937f">ENUMERATE_SIMD_CELL</a></div><div class="ttdeci">#define ENUMERATE_SIMD_CELL(name, group)</div><div class="ttdoc">Enumérateur SIMD sur un groupe ou liste de mailles.</div><div class="ttdef"><b>Definition</b> <a href="../../de/d2d/SimdItem_8h_source.html#l00579">SimdItem.h:579</a></div></div>
<div class="ttc" id="agroup__ArcaneSimd_html_ga1fa29db17212b77758a93b80957fe001"><div class="ttname"><a href="../../d5/d04/group__ArcaneSimd.html#ga1fa29db17212b77758a93b80957fe001">Arcane::SimdCell</a></div><div class="ttdeci">SimdItemT&lt; Cell &gt; SimdCell</div><div class="ttdoc">Vecteur SIMD de Cell.</div><div class="ttdef"><b>Definition</b> <a href="../../de/d2d/SimdItem_8h_source.html#l00504">SimdItem.h:504</a></div></div>
</div><!-- fragment --><p>La vectorisation fonctionne bien tant que tous les éléments du vecteur doivent effectuer la même opération. Les choses se compliquent lorsque cela n'est plus le cas. Notamment, tout ce qui dépend d'une condition est difficilement vectorisable. Il existe aussi des cas où on souhaite faire dans une boucle vectorielle des opérations spécifiques pour chacun des éléments. Pour gérer cette situation, il est possible d'ajouter des sections séquentiels en itérant sur les entités d'un <a class="el" href="../../d5/d75/classArcane_1_1SimdItem.html" title="Gère un vecteur d&#39;entité Item.">Arcane::SimdItem</a> via les macros ENUMERATE_*. Par exemple :</p>
<div class="fragment"><div class="line"><span class="keyword">using namespace </span><a class="code hl_namespace" href="../../d0/d32/namespaceArcane.html">Arcane</a>;</div>
<div class="line"><a class="code hl_define" href="../../d5/d04/group__ArcaneSimd.html#ga0a9dc0b44f6c0935eefd6947014c937f">ENUMERATE_SIMD_CELL</a>(ivcell,allCells()){</div>
<div class="line">  <a class="code hl_typedef" href="../../d5/d04/group__ArcaneSimd.html#ga1fa29db17212b77758a93b80957fe001">SimdCell</a> simd_cell = *ivcell; <span class="comment">// Vecteur de mailles</span></div>
<div class="line">  <a class="code hl_define" href="../../d6/d0f/ItemEnumerator_8h.html#aaf5910d68ad8428248f844535ab071f3">ENUMERATE_CELL</a>(icell,ivcell){</div>
<div class="line">    <a class="code hl_class" href="../../d9/db2/classArcane_1_1Cell.html">Cell</a> cell = *icell;</div>
<div class="line">    info() &lt;&lt; <span class="stringliteral">&quot;Cell: local_id=&quot;</span> &lt;&lt; cell.<a class="code hl_function" href="../../df/d5f/classArcane_1_1Item.html#a337f519e8727634e55ea621f4734ec04">localId</a>();</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="ttc" id="aclassArcane_1_1Item_html_a337f519e8727634e55ea621f4734ec04"><div class="ttname"><a href="../../df/d5f/classArcane_1_1Item.html#a337f519e8727634e55ea621f4734ec04">Arcane::Item::localId</a></div><div class="ttdeci">constexpr Int32 localId() const</div><div class="ttdoc">Identifiant local de l'entité dans le sous-domaine du processeur.</div><div class="ttdef"><b>Definition</b> <a href="../../d1/dd4/Item_8h_source.html#l00206">Item.h:206</a></div></div>
</div><!-- fragment --><p>Enfin, il est possible de connaître le nombre de réels d'un registre vectoriel via la constante SimdReal::BLOCK_SIZE. Cela permet par exemple d'itérer sur les éléments d'un registre vectoriel :</p>
<div class="fragment"><div class="line"><span class="keyword">using namespace </span><a class="code hl_namespace" href="../../d0/d32/namespaceArcane.html">Arcane</a>;</div>
<div class="line"><a class="code hl_class" href="../../d2/d63/classArcane_1_1SimdReal3.html">SimdReal3</a> vr;</div>
<div class="line"><span class="keywordflow">for</span>( Integer i=0, n=SimdReal::BLOCK_SIZE; i&lt;n; ++i ){</div>
<div class="line">  <a class="code hl_class" href="../../d1/da6/classArcane_1_1Real3.html">Real3</a> r = vr[i];</div>
<div class="line">  info() &lt;&lt; <span class="stringliteral">&quot; R [&quot;</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot;] = &quot;</span> &lt;&lt; r;</div>
<div class="line">}</div>
<div class="ttc" id="aclassArcane_1_1Real3_html"><div class="ttname"><a href="../../d1/da6/classArcane_1_1Real3.html">Arcane::Real3</a></div><div class="ttdoc">Classe gérant un vecteur de réel de dimension 3.</div><div class="ttdef"><b>Definition</b> <a href="../../d5/dbb/Real3_8h_source.html#l00130">Real3.h:132</a></div></div>
<div class="ttc" id="aclassArcane_1_1SimdReal3_html"><div class="ttname"><a href="../../d2/d63/classArcane_1_1SimdReal3.html">Arcane::SimdReal3</a></div><div class="ttdoc">Représente un Real3 vectoriel.</div><div class="ttdef"><b>Definition</b> <a href="../../d6/dea/Simd_8h_source.html#l00149">Simd.h:150</a></div></div>
</div><!-- fragment --><h1><a class="anchor" id="arcanedoc_parallel_simd_alignment"></a>
Gestion de l'alignement</h1>
<p>En général, et c'est le cas pour les processeurs x64, l'utilisation de la vectorisation nécessite que les données en mémoires soient alignées d'une manière plus restrictive que pour types scalaires. Pour le SSE, l'AVX et l'AVX512 L'alignement minimal est égal à la taille en octet du vecteur Simd. Donc par exemple pour l'AVX avec des vecteurs de 256 bits, soit 32 octets, l'alignement minimal est de 32 octets. Pour simplifier la vectorisation Arcane garantit que les types suivants ont l'alignement minimal souhaité pour la vectorisation :</p><ul>
<li>les localIds() des <a class="el" href="../../d9/d27/classArcane_1_1ItemGroup.html" title="Groupe d&#39;entités de maillage.">Arcane::ItemGroup</a>.</li>
<li>les données des variables tableaux et scalaires sur le maillage.</li>
<li>les données des variables tableaux 2D et variables tableaux sur le maillage. `A noter que pour ces dernières le début du tableau est aligné mais si la première dimension n'est pas un multiple de la taille du vecteur alors les éléments suivants ne seront pas alignés car il n'y a pas encore de gestion du padding).</li>
</ul>
<p>Le C++ ne permettant pas d'allouer via new/delete avec alignement, Arcane fournit la classe <a class="el" href="../../d0/d7e/classArccore_1_1AlignedMemoryAllocator.html" title="Allocateur mémoire avec alignement mémoire spécifique.">Arccore::AlignedMemoryAllocator</a> qui peut être utilisée avec les classes Arcane::UniqueArray et Arcane::SharedArray pour garantir l'alignement. Par exemple :</p>
<div class="fragment"><div class="line"><span class="keyword">using namespace </span><a class="code hl_namespace" href="../../d0/d32/namespaceArcane.html">Arcane</a>;</div>
<div class="line"><a class="code hl_class" href="../../da/daa/classArccore_1_1UniqueArray.html">UniqueArray</a> x(AlignedMemoryAllocator::Simd());</div>
<div class="line">x.resize(32); <span class="comment">// Garanti que \a x à un alignement correct.</span></div>
</div><!-- fragment --><h1><a class="anchor" id="arcanedoc_parallel_simd_endloop"></a>
Gestion des fins de boucle</h1>
<p>La vectorisation fonctionne bien lorsque le nombre d'éléments de la boucle est un multiple de la taille du vecteur Simd. Si ce n'est pas le cas, il faut traiter la dernière partie de la boucle d'une certaine manière. <b>Afin d'offrir un mécanisme identique pour tous les types de vectorisation, Arcane duplique dans le vecteur Simd la dernière valeur valide</b>. Par exemple, on suppose le code suivant :</p>
<div class="fragment"><div class="line"><span class="keyword">using namespace </span><a class="code hl_namespace" href="../../d0/d32/namespaceArcane.html">Arcane</a>;</div>
<div class="line"><a class="code hl_class" href="../../d8/d8e/classArcane_1_1ItemGroupT.html">CellGroup</a> cells = ...</div>
<div class="line">ENUMERATE_SIMD_CELL(ivcell,cells){</div>
<div class="line">  <a class="code hl_typedef" href="../../d5/d04/group__ArcaneSimd.html#ga1fa29db17212b77758a93b80957fe001">SimdCell</a> simd_cell = *ivcell; <span class="comment">// Vecteur de mailles</span></div>
<div class="line">}</div>
<div class="ttc" id="aclassArcane_1_1ItemGroupT_html"><div class="ttname"><a href="../../d8/d8e/classArcane_1_1ItemGroupT.html">Arcane::ItemGroupT&lt; Cell &gt;</a></div></div>
</div><!-- fragment --><p>Avec <em>cells</em> un groupe de mailles qui contient 11 éléments. Si on suppose que la taille d'un vecteur est 8, alors la boucle précédente fera deux itérations. Pour la première on aura les valeurs suivantes de <em>simd_cell</em> </p>
<div class="fragment"><div class="line"><span class="comment">// Première itération</span></div>
<div class="line">simd_cell[0]  = cells[0];</div>
<div class="line">simd_cell[1]  = cells[1];</div>
<div class="line">simd_cell[2]  = cells[2];</div>
<div class="line">simd_cell[3]  = cells[3];</div>
<div class="line">simd_cell[4]  = cells[4];</div>
<div class="line">simd_cell[5]  = cells[5];</div>
<div class="line">simd_cell[6]  = cells[6];</div>
<div class="line">simd_cell[7]  = cells[7];</div>
</div><!-- fragment --><p>Pour la deuxième itération, comme <em>cells</em> ne contient que 11 éléments, on répète dans <em>simd_cell</em> la dernière valeur valide :</p>
<div class="fragment"><div class="line"><span class="comment">// Deuxième itération</span></div>
<div class="line">simd_cell[8]  = cells[8];</div>
<div class="line">simd_cell[9]  = cells[9];</div>
<div class="line">simd_cell[10] = cells[10];</div>
<div class="line">simd_cell[11] = cells[10]; <span class="comment">// Répète la dernière valeur valide.</span></div>
<div class="line">simd_cell[12] = cells[10];</div>
<div class="line">simd_cell[13] = cells[10];</div>
<div class="line">simd_cell[14] = cells[10];</div>
<div class="line">simd_cell[15] = cells[10];</div>
</div><!-- fragment --><p>Ce mécanisme fonctionne partaitement tant que les opérations effectuées sont bien vectorielles. Si ce n'est pas le cas, il est possible d'itérer uniquement sur les valeurs valides comme suit :</p>
<div class="fragment"><div class="line"><span class="keyword">using namespace </span><a class="code hl_namespace" href="../../d0/d32/namespaceArcane.html">Arcane</a>;</div>
<div class="line"><a class="code hl_class" href="../../d8/d8e/classArcane_1_1ItemGroupT.html">CellGroup</a> cells = ...</div>
<div class="line">ENUMERATE_SIMD_CELL(ivcell,cells){</div>
<div class="line">  <a class="code hl_typedef" href="../../d5/d04/group__ArcaneSimd.html#ga1fa29db17212b77758a93b80957fe001">SimdCell</a> simd_cell = *ivcell; <span class="comment">// Vecteur de mailles</span></div>
<div class="line">  <a class="code hl_define" href="../../d6/d0f/ItemEnumerator_8h.html#aaf5910d68ad8428248f844535ab071f3">ENUMERATE_CELL</a>(icell,ivcell){</div>
<div class="line">    <a class="code hl_class" href="../../d9/db2/classArcane_1_1Cell.html">Cell</a> cell = *icell;</div>
<div class="line">    info() &lt;&lt; <span class="stringliteral">&quot;Cell: local_id=&quot;</span> &lt;&lt; cell.<a class="code hl_function" href="../../df/d5f/classArcane_1_1Item.html#a337f519e8727634e55ea621f4734ec04">localId</a>();</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p>Avec l'exemple précédent, la boucle interne ne fera que 3 itérations, (pour les mailles <em>cells</em>[8], <em>cells</em>[9] et <em>cells</em>[10]) pour la dernière partie de <em>cells</em>.</p>
<h1><a class="anchor" id="arcanedoc_parallel_simd_operation"></a>
Opérations supportées</h1>
<p>Les opérations mathématiquees supportés par les classes vectorielles de Arcane sont définies dans le fichier <a class="el" href="../../df/d8d/SimdMathUtils_8h_source.html">SimdMathUtils.h</a>:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;arcane/SimdMathUtils.h&quot;</span></div>
</div><!-- fragment --><p>Arcane fournit pour les classes vectorielles <a class="el" href="../../d5/d04/group__ArcaneSimd.html#ga5aa9d2a778e46ece234ee1dbf469a04e" title="Vecteur SIMD de réel.">Arcane::SimdReal</a>, <a class="el" href="../../d4/d7a/classArcane_1_1SimdReal2.html" title="Représente un Real2 vectoriel.">Arcane::SimdReal2</a> et <a class="el" href="../../d2/d63/classArcane_1_1SimdReal3.html" title="Représente un Real3 vectoriel.">Arcane::SimdReal3</a> les mêmes opérations que celles disponibles dans <a class="el" href="../../dc/d3e/MathUtils_8h.html" title="Fonctions mathématiques diverses.">MathUtils.h</a> pour la version scalaire à l'exception de <em>min</em> et <em>max</em>.</p>
<h1><a class="anchor" id="arcanedoc_parallel_simd_support"></a>
Mécanismes de vectorisation supportés</h1>
<p>Dans la version 2.2, Arcane ne supporte que la vectorisation pour les processeurs d'architecture x86.</p>
<p>Pour ces processeurs, il existe (actuellement) trois générations de vectorisation :</p>
<ul>
<li>la vectorisation SSE, qui est disponible sur tous les processeurs 64 bits et qui utilisent des registres de 128 bits.</li>
<li>la vectorisation AVX, qui est disponible sur les processeurs depuis la génération SandyBridge (en gros depuis 2012). Ces vecteurs ont une taille de 256 bits.</li>
<li>la vectorisation AVX512, qui est disponible sur les processeurs de génération SkyLake (2015+) et qui dispose de vecteurs de 512 bits. Cette vectorisation est supportée depuis la version 2.3.9 de Arcane.</li>
</ul>
<p>Suivant la plateforme, plusieurs mécanismes peuvent être disponibles. Sur les processeurs Intel les processeurs ont une compatibilité ascendante et donc ceux qui supportent l'AVX512 supportent aussi l'AVX et le SSE. De même, les processeurs avec AVX supportent le SSE.</p>
<p>Arcane définit le mécanisme par défaut comme étant celui qui utilise la vectorisation la plus importante. Les types Arcane::SimdInfo, <a class="el" href="../../d5/d04/group__ArcaneSimd.html#ga5aa9d2a778e46ece234ee1dbf469a04e" title="Vecteur SIMD de réel.">Arcane::SimdReal</a>, <a class="el" href="../../d2/d63/classArcane_1_1SimdReal3.html" title="Représente un Real3 vectoriel.">Arcane::SimdReal3</a> sont donc des typedefs qui dépendent de la plateforme.</p>
<p>Arcane définit aussi des macros indiquant les mécanismes disponibles :</p>
<ul>
<li>ARCANE_HAS_SSE si la vectorisation avec SSE est disponible</li>
<li>ARCANE_HAS_AVX si la vectorisation avec AVX ou AVX2 est disponible</li>
<li>ARCANE_HAS_AVX512 si la vectorisation avec AVX512 est disponible.</li>
</ul>
<hr  />
<div class="section_buttons"> <span class="back_section_button"> <a class="el" href="../../d0/d6b/arcanedoc_parallel_concurrency.html">Concurrence et multi-threading</a> </span> <span class="next_section_button"> <a class="el" href="../../da/da2/arcanedoc_parallel_loadbalance.html">Equilibrage de charge sur le maillage</a> </span> </div> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.5-->
<!-- start footer part -->
  <div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
    <ul>
      <li class="navelem"><a class="el" href="../../index.html">%Arcane</a></li><li class="navelem"><a class="el" href="../../df/d78/arcanedoc_parallel.html">Paralléliser un code</a></li>
      <li class="footer">Généré le Lundi 22 Juillet 2024 02:43:19 pour Arcane par <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
    </ul>
  </div>
  <script type="text/javascript" src="../../script-apply-config-theme.js"></script>
  <script type="text/javascript">
    // On met l'appel à cette fonction dans le footer dans le cas où
    // une page ne veut pas de personnalisation (changement de la 
    // variable globale "no_custom_theme").
    applyConfigWithCookies();
  </script>
</body>
</html>
