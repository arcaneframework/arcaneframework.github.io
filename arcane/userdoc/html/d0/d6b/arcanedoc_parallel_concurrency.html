<!-- HTML header for doxygen 1.9.5-->
<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=11" />
    <meta name="generator" content="Doxygen 1.9.6" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Arcane: Concurrence et multi-threading</title>
    <link href="../../tabs.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="../../jquery.js"></script>
    <script type="text/javascript" src="../../dynsections.js"></script>
    <link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
    <link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript">
window.MathJax = {
  options: {
    ignoreHtmlClass: 'tex2jax_ignore',
    processHtmlClass: 'tex2jax_process'
  }
};
</script>
<script type="text/javascript" id="MathJax-script" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    <link href="../../doxygen.css" rel="stylesheet" type="text/css" />
    <link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-custom.css" rel="stylesheet" type="text/css"/>
<link href="../../custom.css" rel="stylesheet" type="text/css"/>
<link href="../../user_colors.css" rel="stylesheet" type="text/css"/>
    <script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
    <script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
    <script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
    <script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
    <script type="text/javascript" src="../../doxygen-awesome-tabs.js"></script>
    <script type="text/javascript" src="../../script-helper.js"></script>
    <script type="text/javascript" src="../../script-resize.js"></script>
    <script type="text/javascript" src="../../script-num-lines-code.js"></script>
    <script type="text/javascript" src="../../script-config-theme.js"></script>
    <script type="text/javascript" src="../../script-edit-config-theme.js"></script>
    <script type="text/javascript" src="../../script-alternative-theme.js"></script>
    <script type="text/javascript">
      // On demande l'activation de la personnalisation de la page.
      var no_custom_theme = false;
      DoxygenAwesomeDarkModeToggle.title = "Thème clair/sombre";
      DoxygenAwesomeDarkModeToggle.init();
      DoxygenAwesomeFragmentCopyButton.title = "Copier le code dans le presse-papier";
      DoxygenAwesomeFragmentCopyButton.init();
      DoxygenAwesomeParagraphLink.init();
      DoxygenAwesomeInteractiveToc.init();
      DoxygenAwesomeTabs.init()
      waitElemForResizeSideNav();
      setOldSize();
      //waitItemExpandCurrent();
    </script>
  </head>
  <body>
    <!--BEGIN CORNER_GITHUB-->
    <!-- https://tholman.com/github-corners/ -->
    <a href="https://github.com/arcaneframework/framework" class="github-corner" aria-label="Voir les sources sur GitHub">
      <svg width="70" height="70" viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path
          d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
          fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path
          d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
          fill="currentColor" class="octo-body"></path>
      </svg>
    </a>
    <!--END CORNER_GITHUB-->
      <div id="top">
        <!-- do not remove this div, it is closed by doxygen! -->
        <div id="titlearea">
          <table cellspacing="0" cellpadding="0">
            <tbody>
              <tr id="projectrow">
                <td id="projectlogo">
                  <a href="../../index.html" title="Aller à la page principale">
                    <img alt="Logo" src="../../arcane_logo.webp" />
                  </a>
                </td>
              </tr>
              <tr id="projectrow">
                <td id="projectalign">
                  <div id="projectname">Arcane
                    <span id="projectnumber">&#160;v3.12.9.0</span>
                  </div>
                  <div id="projectbrief">Documentation utilisateur</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- end header part --><!-- Généré par Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Recherche');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d0/d6b/arcanedoc_parallel_concurrency.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Chargement...</div>
<div class="SRStatus" id="Searching">Recherche...</div>
<div class="SRStatus" id="NoMatches">Aucune correspondance</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Concurrence et multi-threading </div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table des matières</h3>
<ul><li class="level1"><a href="#arcanedoc_parallel_concurrency_activation">Activation</a></li>
<li class="level1"><a href="#arcanedoc_parallel_concurrency_parallel_for">Boucles parallèles</a></li>
<li class="level1"><a href="#arcanedoc_parallel_concurrency_task">Utilisation explicite des tâches</a></li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md_doc_doc_user_chap_parallel_2_concurrency"></a></p>
<p>La notion de concurrence est implémentée dans Arcane via la notion de tâche.</p>
<p>Cette notion de tâche permet l'exécution concurrente de plusieurs opérations via les threads.</p>
<p>Cette notion est complémentaire de la notion de décomposition de domaine utilisée par le <a class="el" href="../../dc/d5a/classArcane_1_1IParallelMng.html" title="Interface du gestionnaire de parallélisme pour un sous-domaine.">Arcane::IParallelMng</a>. Il est donc tout à fait possible de mélanger décomposition de domaine et les threads.</p>
<dl class="section warning"><dt>Avertissement</dt><dd>Néanmoins, si l'implémentation de <a class="el" href="../../dc/d5a/classArcane_1_1IParallelMng.html" title="Interface du gestionnaire de parallélisme pour un sous-domaine.">Arcane::IParallelMng</a> se fait via MPI, il est déconseillé de faire des appels au <a class="el" href="../../dc/d5a/classArcane_1_1IParallelMng.html" title="Interface du gestionnaire de parallélisme pour un sous-domaine.">Arcane::IParallelMng</a> lorsque des tâches se déroulent de manière concurrente, par exemle dans les boucles parallélisées. La plupart des implémentations MPI ne sont pas très performantes dans ce mode et certaines ne le supporte que partiellement.</dd></dl>
<p>Pour utiliser les tâches, il faut inclure le fichier suivant :</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;arcane/Concurrency.h&quot;</span></div>
</div><!-- fragment --><p>Il existe deux mécanismes pour utiliser les tâches :</p>
<ol type="1">
<li>Implicitement via la notion de boucle parallèle</li>
<li>explicitement en créant les tâches directement</li>
</ol>
<p>La première solution est la plus simple et doit être envisagée en priorité.</p>
<h1><a class="anchor" id="arcanedoc_parallel_concurrency_activation"></a>
Activation</h1>
<p>Par défaut, le support de la concurrence est désactivé. L'activation se fait <b>avant</b> le lancement du code, en spécifiant le nombre de tâches pouvant s'exécuter de manière concurrentes lors de la ligne de commande (se reporter à la page <a class="el" href="../../d8/dd6/arcanedoc_execution_launcher.html">Lancement d'un calcul</a> pour savoir comment faire cela).</p>
<p>Il est possible de savoir dans le code si la concurrence est active en appelant la méthode <a class="el" href="../../d6/d0d/classArcane_1_1TaskFactory.html#ac1c5f1d4743f2a7b0e8d2e4151ea928a" title="Indique si les tâches sont actives. Les tâches sont actives si une implémentation est disponible et s...">Arcane::TaskFactory::isActive()</a>.</p>
<p>Il n'est pas possible d'activer la concurrence pendant l'exécution.</p>
<h1><a class="anchor" id="arcanedoc_parallel_concurrency_parallel_for"></a>
Boucles parallèles</h1>
<p>Il existe deux formes de boucles parallèles. La première forme s'applique sur les boucles classiques, la seconde sur les groupes d'entités.</p>
<p>Le mécanisme de fonctionnement est similaire aux directives <code>omp parallel for</code> de OpenMp.</p>
<dl class="section warning"><dt>Avertissement</dt><dd>L'utilisateur de ce mécanisme doit s'assurer que la boucle peut être correctement parallélisée sans qu'il y ait d'effets de bord. Notamment, cela inclut (mais ne se limite pas) la garantie que les itérations de la boucle sont indépendantes, qu'il n'y a pas d'opérations de sortie de boucle (return, break).</dd></dl>
<p>La première forme est pour paralléliser la boucle séquentielle suivante :</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> func()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">for</span>( Integer i=0; i&lt;n; ++i )</div>
<div class="line">    p[i] = (gamma[i]-1) * rho[i] * e[i];</div>
<div class="line">}</div>
</div><!-- fragment --><p>La parallélisation se fait comme suit : il faut d'abord écrire une classe fonctor qui représente l'opération que l'on souhaite effectuée sur un interval d'itération. Ensuite, il faut utiliser l'opération arcaneParallelFor() en spécifiant ce fonctor en argument comme suit :</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>Func</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">   <span class="keywordtype">void</span> exec(Integer begin,Integer size)</div>
<div class="line">   {</div>
<div class="line">     <span class="keywordflow">for</span>( Integer i=begin; i&lt;(begin+size); ++i )</div>
<div class="line">       p[i] = (gamma[i]-1) * rho[i] * e[i];</div>
<div class="line">   }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> func()</div>
<div class="line">{</div>
<div class="line">  Func my_functor;</div>
<div class="line">  <a class="code hl_function" href="../../d4/dad/group__Concurrency.html#ga3ccb4306b9c1745f2f5b2f72e727e9cd">Arcane::arcaneParallelFor</a>(0,n,&amp;my_functor,&amp;Func::exec);</div>
<div class="line">}</div>
<div class="ttc" id="agroup__Concurrency_html_ga3ccb4306b9c1745f2f5b2f72e727e9cd"><div class="ttname"><a href="../../d4/dad/group__Concurrency.html#ga3ccb4306b9c1745f2f5b2f72e727e9cd">Arcane::arcaneParallelFor</a></div><div class="ttdeci">void arcaneParallelFor(Integer i0, Integer size, InstanceType *itype, void(InstanceType::*lambda_function)(Integer i0, Integer size))</div><div class="ttdoc">Applique en concurrence la fonction lambda lambda_function sur l'intervalle d'itération [i0,...</div><div class="ttdef"><b>Definition:</b> <a href="../../d4/d05/Concurrency_8h_source.html#l00199">Concurrency.h:199</a></div></div>
</div><!-- fragment --><p>Cette syntaxe est un peu verbeuse. Si le compilateur supporte la norme C++11, il est possible d'utiliser les lambda function pour simplifier l'écriture :</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> func()</div>
<div class="line">{</div>
<div class="line">  <a class="code hl_function" href="../../d4/dad/group__Concurrency.html#ga3ccb4306b9c1745f2f5b2f72e727e9cd">Arcane::arcaneParallelFor</a>(0,n,[&amp;](Integer begin,Integer size){</div>
<div class="line">     <span class="keywordflow">for</span>( Integer i=begin; i&lt;(begin+size); ++i )</div>
<div class="line">       p[i] = (gamma[i]-1.0) * rho[i] * e[i];</div>
<div class="line">  });</div>
<div class="line">}</div>
</div><!-- fragment --><p>Une spécialisation existe pour les groupes d'entités. Pour paralléliser une énumération sur un groupe comme le code suivant :</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> func()</div>
<div class="line">{</div>
<div class="line">  <a class="code hl_define" href="../../d6/d0f/ItemEnumerator_8h.html#aaf5910d68ad8428248f844535ab071f3">ENUMERATE_CELL</a>(icell,my_group){</div>
<div class="line">    p[icell] = (gamma[icell]-1.0) * rho[icell] * e[icell];</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="ttc" id="aItemEnumerator_8h_html_aaf5910d68ad8428248f844535ab071f3"><div class="ttname"><a href="../../d6/d0f/ItemEnumerator_8h.html#aaf5910d68ad8428248f844535ab071f3">ENUMERATE_CELL</a></div><div class="ttdeci">#define ENUMERATE_CELL(name, group)</div><div class="ttdoc">Enumérateur générique d'un groupe de mailles.</div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d0f/ItemEnumerator_8h_source.html#l00420">ItemEnumerator.h:420</a></div></div>
</div><!-- fragment --><p>Il faut écrire comme cela :</p>
<div class="fragment"><div class="line"><span class="keyword">using namespace </span><a class="code hl_namespace" href="../../d0/d32/namespaceArcane.html">Arcane</a>;</div>
<div class="line"><span class="keyword">class </span>Func</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">   <span class="keywordtype">void</span> exec(<a class="code hl_class" href="../../d7/d90/classArcane_1_1ItemVectorViewT.html">CellVectorView</a> view)</div>
<div class="line">   {</div>
<div class="line">     <a class="code hl_define" href="../../d6/d0f/ItemEnumerator_8h.html#aaf5910d68ad8428248f844535ab071f3">ENUMERATE_CELL</a>(icell,view){</div>
<div class="line">       p[icell] = (gamma[icell]-1.0) * rho[icell] * e[icell];</div>
<div class="line">     }</div>
<div class="line">   }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> func()</div>
<div class="line">{</div>
<div class="line">  Func my_functor;</div>
<div class="line">  arcaneParallelForeach(my_group,&amp;my_functor,&amp;Func::exec);</div>
<div class="line">}</div>
<div class="ttc" id="aclassArcane_1_1ItemVectorViewT_html"><div class="ttname"><a href="../../d7/d90/classArcane_1_1ItemVectorViewT.html">Arcane::ItemVectorViewT</a></div><div class="ttdoc">Vue sur un tableau typé d'entités.</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d5d/ItemVectorView_8h_source.html#l00394">ItemVectorView.h:396</a></div></div>
<div class="ttc" id="anamespaceArcane_html"><div class="ttname"><a href="../../d0/d32/namespaceArcane.html">Arcane</a></div><div class="ttdoc">-*- tab-width: 2; indent-tabs-mode: nil; coding: utf-8-with-signature -*-</div><div class="ttdef"><b>Definition:</b> <a href="../../de/df4/AbstractCaseDocumentVisitor_8cc_source.html#l00020">AbstractCaseDocumentVisitor.cc:20</a></div></div>
</div><!-- fragment --><p>De même, avec le support du C++11, on peut simplifier :</p>
<div class="fragment"><div class="line"><span class="keyword">using namespace </span><a class="code hl_namespace" href="../../d0/d32/namespaceArcane.html">Arcane</a>;</div>
<div class="line"><span class="keywordtype">void</span> func()</div>
<div class="line">{</div>
<div class="line">  arcaneParallelForeach(my_group,[&amp;](<a class="code hl_class" href="../../d7/d90/classArcane_1_1ItemVectorViewT.html">CellVectorView</a> cells){</div>
<div class="line">    <a class="code hl_define" href="../../d6/d0f/ItemEnumerator_8h.html#aaf5910d68ad8428248f844535ab071f3">ENUMERATE_CELL</a>(icell,cells){</div>
<div class="line">      p[icell] = (gamma[icell]-1.0) * rho[icell] * e[icell];</div>
<div class="line">    }</div>
<div class="line">  });</div>
<div class="line">}</div>
</div><!-- fragment --><p>Pour les boucles <a class="el" href="../../d4/dad/group__Concurrency.html#ga3ccb4306b9c1745f2f5b2f72e727e9cd" title="Applique en concurrence la fonction lambda lambda_function sur l&#39;intervalle d&#39;itération [i0,...">Arcane::arcaneParallelFor()</a> et <a class="el" href="../../d4/dad/group__Concurrency.html#ga2dc1621d6f49d59fd2ed1c8b16bfd20c" title="Applique en concurrence la méthode function de l&#39;instance instance sur la vue items_view avec les opt...">Arcane::arcaneParallelForeach()</a>, il est possible de passer en argument une instance de ParallelLoopOptions pour configurer la boucle parallèle. Par exemple, il est possible de spécifier la taille de l'intervalle pour découper la boucle :</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> func()</div>
<div class="line">{</div>
<div class="line">  <a class="code hl_class" href="../../d9/d62/classArcane_1_1ParallelLoopOptions.html">Arcane::ParallelLoopOptions</a> options;</div>
<div class="line">  <span class="comment">// Exécute la boucle par parties d&#39;environ 50 mailles.</span></div>
<div class="line">  options.<a class="code hl_function" href="../../d9/d62/classArcane_1_1ParallelLoopOptions.html#abb6d3a03def71e968fb0a8f200319c66">setGrainSize</a>(50);</div>
<div class="line">  <a class="code hl_function" href="../../d4/dad/group__Concurrency.html#ga2dc1621d6f49d59fd2ed1c8b16bfd20c">Arcane::arcaneParallelForeach</a>(my_group,options,[&amp;](<a class="code hl_class" href="../../d7/d90/classArcane_1_1ItemVectorViewT.html">Arcane::CellVectorView</a> cells){</div>
<div class="line">    <a class="code hl_define" href="../../d6/d0f/ItemEnumerator_8h.html#aaf5910d68ad8428248f844535ab071f3">ENUMERATE_CELL</a>(icell,cells){</div>
<div class="line">      p[icell] = (gamma[icell]-1.0) * rho[icell] * e[icell];</div>
<div class="line">    }</div>
<div class="line">  });</div>
<div class="line">}</div>
<div class="ttc" id="aclassArcane_1_1ParallelLoopOptions_html"><div class="ttname"><a href="../../d9/d62/classArcane_1_1ParallelLoopOptions.html">Arcane::ParallelLoopOptions</a></div><div class="ttdoc">Options d'exécution d'une boucle parallèle en multi-thread.</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d49/ParallelLoopOptions_8h_source.html#l00035">ParallelLoopOptions.h:36</a></div></div>
<div class="ttc" id="aclassArcane_1_1ParallelLoopOptions_html_abb6d3a03def71e968fb0a8f200319c66"><div class="ttname"><a href="../../d9/d62/classArcane_1_1ParallelLoopOptions.html#abb6d3a03def71e968fb0a8f200319c66">Arcane::ParallelLoopOptions::setGrainSize</a></div><div class="ttdeci">void setGrainSize(Integer v)</div><div class="ttdoc">Positionne la taille (approximative) d'un intervalle d'itération.</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d49/ParallelLoopOptions_8h_source.html#l00111">ParallelLoopOptions.h:111</a></div></div>
<div class="ttc" id="agroup__Concurrency_html_ga2dc1621d6f49d59fd2ed1c8b16bfd20c"><div class="ttname"><a href="../../d4/dad/group__Concurrency.html#ga2dc1621d6f49d59fd2ed1c8b16bfd20c">Arcane::arcaneParallelForeach</a></div><div class="ttdeci">void arcaneParallelForeach(const ItemVectorView &amp;items_view, const ForLoopRunInfo &amp;run_info, InstanceType *instance, void(InstanceType::*function)(ItemVectorViewT&lt; ItemType &gt; items))</div><div class="ttdoc">Applique en concurrence la méthode function de l'instance instance sur la vue items_view avec les opt...</div><div class="ttdef"><b>Definition:</b> <a href="../../d4/d05/Concurrency_8h_source.html#l00054">Concurrency.h:54</a></div></div>
</div><!-- fragment --><h1><a class="anchor" id="arcanedoc_parallel_concurrency_task"></a>
Utilisation explicite des tâches</h1>
<p>La création d'un tâche se fait via la fabrique de tâche. Il faut spécifier en argument un fonctor de la même manière que les boucles parallèles :</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>Func</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">   <span class="keywordtype">void</span> exec(<span class="keyword">const</span> <a class="code hl_class" href="../../d3/df6/classArcane_1_1TaskContext.html">TaskContext</a>&amp; ctx)</div>
<div class="line">   {</div>
<div class="line">     <span class="comment">// Execute la tâche.</span></div>
<div class="line">   }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> func()</div>
<div class="line">{</div>
<div class="line">  Func my_functor</div>
<div class="line">  <a class="code hl_class" href="../../da/dd2/classArcane_1_1ITask.html">Arcane::ITask</a>* master_task = <a class="code hl_function" href="../../d6/d0d/classArcane_1_1TaskFactory.html#ac9523e9373bf80a7c13fb0256cee7745">Arcane::TaskFactory::createTask</a>(&amp;my_functor,&amp;Func::exec);</div>
<div class="line">}</div>
<div class="ttc" id="aclassArcane_1_1ITask_html"><div class="ttname"><a href="../../da/dd2/classArcane_1_1ITask.html">Arcane::ITask</a></div><div class="ttdoc">Interface d'une tâche concourante.</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d3c/ConcurrencyUtils_8h_source.html#l00158">ConcurrencyUtils.h:159</a></div></div>
<div class="ttc" id="aclassArcane_1_1TaskContext_html"><div class="ttname"><a href="../../d3/df6/classArcane_1_1TaskContext.html">Arcane::TaskContext</a></div><div class="ttdoc">Contexte d'éxecution d'une tâche.</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d3c/ConcurrencyUtils_8h_source.html#l00047">ConcurrencyUtils.h:48</a></div></div>
<div class="ttc" id="aclassArcane_1_1TaskFactory_html_ac9523e9373bf80a7c13fb0256cee7745"><div class="ttname"><a href="../../d6/d0d/classArcane_1_1TaskFactory.html#ac9523e9373bf80a7c13fb0256cee7745">Arcane::TaskFactory::createTask</a></div><div class="ttdeci">static ITask * createTask(InstanceType *instance, void(InstanceType::*function)(const TaskContext &amp;tc))</div><div class="ttdoc">Créé une tâche. Lors de l'exécution, la tâche appellera la méthode function via l'instance instance.</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d3c/ConcurrencyUtils_8h_source.html#l00287">ConcurrencyUtils.h:287</a></div></div>
</div><!-- fragment --><p>Une fois la tâche créée, il est possible de la lancer et d'attendre sa terminaison via la méthode ITask::launchAndWait(). Pour des raisons de simplicité, la tâche n'est pas lancée tant que cette méthode n'a pas été appelée.</p>
<p>Il est possible de créer des sous-tâches à partir d'une première tâche via la méthode <a class="el" href="../../d6/d0d/classArcane_1_1TaskFactory.html#a99d296312e13c9e24526f9e20884702b" title="Créé une tâche fille.">Arcane::TaskFactory::createChildTask()</a>. L'utilisateur doit gérer le lancement et l'attente des sous-tâches. Par exemple :</p>
<div class="fragment"><div class="line"><span class="keyword">using namespace </span><a class="code hl_namespace" href="../../d0/d32/namespaceArcane.html">Arcane</a>;</div>
<div class="line"><a class="code hl_class" href="../../da/dd2/classArcane_1_1ITask.html">ITask</a>* master_task = TaskFactory::createTask(...);</div>
<div class="line"><a class="code hl_class" href="../../da/daa/classArccore_1_1UniqueArray.html">UniqueArray&lt;ITask*&gt;</a> sub_tasks;</div>
<div class="line">sub_tasks.<a class="code hl_function" href="../../d9/d09/classArccore_1_1Array.html#ab3f2d332e7c412261b9199bb5454e31b">add</a>(TaskFactory::createChildTask(master_task,&amp;my_functor,&amp;Func::exec);</div>
<div class="line">sub_tasks.<a class="code hl_function" href="../../d9/d09/classArccore_1_1Array.html#ab3f2d332e7c412261b9199bb5454e31b">add</a>(TaskFactory::createChildTask(master_task,&amp;my_functor,&amp;Func::exec);</div>
<div class="line">master_task-&gt;<a class="code hl_function" href="../../da/dd2/classArcane_1_1ITask.html#aeaf5b8ec85a62b095915c808e7a61475">launchAndWait</a>(sub_tasks);</div>
<div class="ttc" id="aclassArcane_1_1ITask_html_aeaf5b8ec85a62b095915c808e7a61475"><div class="ttname"><a href="../../da/dd2/classArcane_1_1ITask.html#aeaf5b8ec85a62b095915c808e7a61475">Arcane::ITask::launchAndWait</a></div><div class="ttdeci">virtual void launchAndWait()=0</div><div class="ttdoc">Lance la tâche et bloque jusqu'à ce qu'elle se termine.</div></div>
<div class="ttc" id="aclassArccore_1_1Array_html_ab3f2d332e7c412261b9199bb5454e31b"><div class="ttname"><a href="../../d9/d09/classArccore_1_1Array.html#ab3f2d332e7c412261b9199bb5454e31b">Arccore::Array::add</a></div><div class="ttdeci">void add(ConstReferenceType val)</div><div class="ttdoc">Ajoute l'élément val à la fin du tableau.</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d85/arccore_2src_2collections_2arccore_2collections_2Array_8h_source.html#l01113">arccore/src/collections/arccore/collections/Array.h:1113</a></div></div>
<div class="ttc" id="aclassArccore_1_1UniqueArray_html"><div class="ttname"><a href="../../da/daa/classArccore_1_1UniqueArray.html">Arccore::UniqueArray</a></div><div class="ttdoc">Vecteur 1D de données avec sémantique par valeur (style STL).</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d85/arccore_2src_2collections_2arccore_2collections_2Array_8h_source.html#l01708">arccore/src/collections/arccore/collections/Array.h:1710</a></div></div>
</div><!-- fragment --><p>L'exemple complet suivant montre l'implémentation du calcul d'une suite de Fibonacci via le mécanisme des tâches.</p>
<div class="fragment"><div class="line"><span class="keyword">using namespace </span><a class="code hl_namespace" href="../../d0/d32/namespaceArcane.html">Arcane</a>;</div>
<div class="line"><span class="keyword">class </span>Fibonnaci</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line"> <span class="keyword">const</span> <span class="keywordtype">long</span> n;</div>
<div class="line"> <span class="keywordtype">long</span>* <span class="keyword">const</span> sum;</div>
<div class="line"> Fibonnaci( <span class="keywordtype">long</span> n_, <span class="keywordtype">long</span>* sum_ ) : n(n_), sum(sum_)</div>
<div class="line"> {}</div>
<div class="line"> <span class="keywordtype">void</span> execute(<span class="keyword">const</span> <a class="code hl_class" href="../../d3/df6/classArcane_1_1TaskContext.html">TaskContext</a>&amp; context)</div>
<div class="line"> {</div>
<div class="line">   <span class="keywordflow">if</span>( n&lt;10 ) {</div>
<div class="line">     *sum = SerialFib(n);</div>
<div class="line">   }</div>
<div class="line">   <span class="keywordflow">else</span> {</div>
<div class="line">     <span class="keywordtype">long</span> x, y;</div>
<div class="line">     Fibonnaci a(n-1,&amp;x);</div>
<div class="line">     Fibonnaci b(n-2,&amp;y);</div>
<div class="line">     <a class="code hl_class" href="../../da/dd2/classArcane_1_1ITask.html">ITask</a>* child_tasks[2];</div>
<div class="line">     <a class="code hl_class" href="../../da/dd2/classArcane_1_1ITask.html">ITask</a>* parent_task = context.<a class="code hl_function" href="../../d3/df6/classArcane_1_1TaskContext.html#af148d9ad88fd78d31940226ed82e363e">task</a>();</div>
<div class="line">     child_tasks[0] = TaskFactory::createChildTask(parent_task,&amp;a,&amp;Test5Fibonnaci::execute);</div>
<div class="line">     child_tasks[1] = TaskFactory::createChildTask(parent_task,&amp;b,&amp;Test5Fibonnaci::execute);</div>
<div class="line">     parent_task-&gt;<a class="code hl_function" href="../../da/dd2/classArcane_1_1ITask.html#aeaf5b8ec85a62b095915c808e7a61475">launchAndWait</a>(<a class="code hl_class" href="../../db/d8c/classArccore_1_1ConstArrayView.html">ConstArrayView&lt;ITask*&gt;</a>(2,child_tasks));</div>
<div class="line"> </div>
<div class="line">     <span class="comment">// Effectue la somme</span></div>
<div class="line">     *sum = x+y;</div>
<div class="line">   }</div>
<div class="line"> }</div>
<div class="line"> <span class="keyword">static</span> <span class="keywordtype">long</span> SerialFib( <span class="keywordtype">long</span> n )</div>
<div class="line"> {</div>
<div class="line">   <span class="keywordflow">if</span>( n&lt;2 )</div>
<div class="line">     <span class="keywordflow">return</span> n;</div>
<div class="line">   <span class="keywordflow">else</span></div>
<div class="line">     <span class="keywordflow">return</span> SerialFib(n-1)+SerialFib(n-2);</div>
<div class="line"> }</div>
<div class="line"> <span class="keyword">static</span> <span class="keywordtype">long</span> ParallelFib( <span class="keywordtype">long</span> n )</div>
<div class="line"> {</div>
<div class="line">   <span class="keywordtype">long</span> sum;</div>
<div class="line">   Test5Fibonnaci a(n,&amp;sum);</div>
<div class="line">   <a class="code hl_class" href="../../da/dd2/classArcane_1_1ITask.html">ITask</a>* task = TaskFactory::createTask(&amp;a,&amp;Test5Fibonnaci::execute);</div>
<div class="line">   task-&gt;<a class="code hl_function" href="../../da/dd2/classArcane_1_1ITask.html#aeaf5b8ec85a62b095915c808e7a61475">launchAndWait</a>();</div>
<div class="line">   <span class="keywordflow">return</span> sum;</div>
<div class="line"> }</div>
<div class="line">};</div>
<div class="ttc" id="aclassArcane_1_1TaskContext_html_af148d9ad88fd78d31940226ed82e363e"><div class="ttname"><a href="../../d3/df6/classArcane_1_1TaskContext.html#af148d9ad88fd78d31940226ed82e363e">Arcane::TaskContext::task</a></div><div class="ttdeci">ITask * task() const</div><div class="ttdoc">Tâche courante.</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d3c/ConcurrencyUtils_8h_source.html#l00053">ConcurrencyUtils.h:53</a></div></div>
<div class="ttc" id="aclassArccore_1_1ConstArrayView_html"><div class="ttname"><a href="../../db/d8c/classArccore_1_1ConstArrayView.html">Arccore::ConstArrayView</a></div><div class="ttdoc">Vue constante d'un tableau de type T.</div><div class="ttdef"><b>Definition:</b> <a href="../../db/d51/arccore_2src_2base_2arccore_2base_2ArrayView_8h_source.html#l00535">arccore/src/base/arccore/base/ArrayView.h:536</a></div></div>
</div><!-- fragment --><hr  />
<div class="section_buttons"> <span class="back_section_button"> <a class="el" href="../../d9/da4/arcanedoc_parallel_intro.html">Prise en compte du parallélisme dans Arcane</a> </span> <span class="next_section_button"> <a class="el" href="../../db/d95/arcanedoc_parallel_simd.html">Vectorisation</a> </span> </div> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.5-->
<!-- start footer part -->
  <div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
    <ul>
      <li class="navelem"><a class="el" href="../../index.html">%Arcane</a></li><li class="navelem"><a class="el" href="../../df/d78/arcanedoc_parallel.html">Paralléliser un code</a></li>
      <li class="footer">Généré le Lundi 11 Mars 2024 02:14:46 pour Arcane par <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6 </li>
    </ul>
  </div>
  <script type="text/javascript" src="../../script-apply-config-theme.js"></script>
  <script type="text/javascript">
    // On met l'appel à cette fonction dans le footer dans le cas où
    // une page ne veut pas de personnalisation (changement de la 
    // variable globale "no_custom_theme").
    applyConfigWithCookies();
  </script>
</body>
</html>
