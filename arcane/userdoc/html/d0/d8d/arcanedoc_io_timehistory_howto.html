<!-- HTML header for doxygen 1.9.5-->
<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=11" />
    <meta name="generator" content="Doxygen 1.9.8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="../../logo_arcane.svg" type="image/svg+xml">
    <title>Arcane: Comment ça fonctionne</title>
    <link href="../../tabs.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="../../jquery.js"></script>
    <script type="text/javascript" src="../../dynsections.js"></script>
    <link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
    <link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript">
window.MathJax = {
  options: {
    ignoreHtmlClass: 'tex2jax_ignore',
    processHtmlClass: 'tex2jax_process'
  }
};
</script>
<script type="text/javascript" id="MathJax-script" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    <link href="../../doxygen.css" rel="stylesheet" type="text/css" />
    <link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-custom.css" rel="stylesheet" type="text/css"/>
<link href="../../custom.css" rel="stylesheet" type="text/css"/>
<link href="../../user_colors.css" rel="stylesheet" type="text/css"/>
    <script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
    <script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
    <script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
    <script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
    <script type="text/javascript" src="../../doxygen-awesome-tabs.js"></script>
    <script type="text/javascript" src="../../script-helper.js"></script>
    <script type="text/javascript" src="../../script-resize.js"></script>
    <script type="text/javascript" src="../../script-num-lines-code.js"></script>
    <script type="text/javascript" src="../../script-config-theme.js"></script>
    <script type="text/javascript" src="../../script-edit-config-theme.js"></script>
    <script type="text/javascript" src="../../script-alternative-theme.js"></script>
    <script type="text/javascript">
      // On demande l'activation de la personnalisation de la page.
      var no_custom_theme = false;
      DoxygenAwesomeDarkModeToggle.title = "Thème clair/sombre";
      DoxygenAwesomeDarkModeToggle.init();
      DoxygenAwesomeFragmentCopyButton.title = "Copier le code dans le presse-papier";
      DoxygenAwesomeFragmentCopyButton.init();
      DoxygenAwesomeParagraphLink.init();
      DoxygenAwesomeInteractiveToc.init();
      DoxygenAwesomeTabs.init()
      waitElemForResizeSideNav();
      setOldSize();
      //waitItemExpandCurrent();
    </script>
  </head>
  <body>
    <!--BEGIN CORNER_GITHUB-->
    <!-- https://tholman.com/github-corners/ -->
    <a href="https://github.com/arcaneframework/framework" class="github-corner" aria-label="Voir les sources sur GitHub">
      <svg width="70" height="70" viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path
          d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
          fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path
          d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
          fill="currentColor" class="octo-body"></path>
      </svg>
    </a>
    <!--END CORNER_GITHUB-->
      <div id="top">
        <!-- do not remove this div, it is closed by doxygen! -->
        <div id="titlearea">
          <table cellspacing="0" cellpadding="0">
            <tbody>
              <tr id="projectrow">
                <td id="projectlogo">
                  <a href="../../index.html" title="Aller à la page principale">
                    <img alt="Logo" src="../../arcane_framework_small.webp" />
                  </a>
                </td>
              </tr>
              <tr id="projectrow">
                <td id="projectalign">
                  <div id="projectname">Arcane
                    <span id="projectnumber">&#160;v3.13.6.0</span>
                  </div>
                  <div id="projectbrief">Documentation utilisateur</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- end header part -->
<!-- Généré par Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Recherche');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d0/d8d/arcanedoc_io_timehistory_howto.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Chargement...</div>
<div class="SRStatus" id="Searching">Recherche...</div>
<div class="SRStatus" id="NoMatches">Aucune correspondance</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Comment ça fonctionne</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table des matières</h3>
<ul><li class="level1"><a href="#autotoc_md135">GlobalTimeHistoryAdder</a></li>
<li class="level1"><a href="#autotoc_md136">MeshTimeHistoryAdder</a></li>
</ul>
</div>
<div class="textblock"><p>L'utilisation du TimeHistory est extrêmement simple.</p>
<p>À chaque itération, une valeur sera enregistrée pour chaque historique de valeurs. S'il n'y a pas d'enregistrement de valeur explicite lors d'une itération, un 0 sera enregistré. S'il y a deux valeurs enregistrées pendant une même itération pour un historique de valeurs, c'est la dernière valeur qui sera réellement enregistrée.</p>
<p>Historiquement, les historiques de valeurs étaient gérés uniquement par le processus 0. Aujourd'hui, ce n'est plus le cas. Chaque processus peut avoir son historique, avec une même clef. De plus, on peut lier un historique à un maillage. Ainsi, on peut avoir un historique par maillage, toujours avec la même clef.</p>
<dl class="section warning"><dt>Avertissement</dt><dd>Pour activer l'enregistrement en multi-processus, il est nécessaire de définir la variable d'environnement <code>ARCANE_ENABLE_NON_IO_MASTER_CURVES=1</code>.</dd></dl>
<h1><a class="anchor" id="autotoc_md135"></a>
GlobalTimeHistoryAdder</h1>
<p>La première structure permettant de gérer des historiques de valeurs est le <code>GlobalTimeHistoryAdder</code>. Il permet d'ajouter des valeurs à un historique. Le "Global" signifie que les variables internes utilisées pour gérer cet historique sont globales, liées aux sous-domaines.</p>
<p>Admettons que l'on ai un maillage partagé dans quatre sous-domaines (<code>SD0</code>, <code>SD1</code>, <code>SD2</code>, <code>SD3</code>). Chaque maille possède une pression. On veut avoir, pour chaque itération, la pression moyenne de chaque sous-domaine. Et en plus, on veut avoir la pression moyenne de tout le domaines.</p>
<p>Utilisons comme clef : <code>avg_pressure</code> : </p><div class="image">
<object type="image/svg+xml" data="../../avg_pressure.svg" style="pointer-events: none;"></object>
</div>
<p>Chaque sous-domaine possède une pression moyenne et il y a une pression moyenne globale. L'image présente une seule itération : l'itération 0.</p>
<p>Pour obtenir un historique comme celui-ci, on peut faire comme ceci : </p><div class="fragment"><div class="line">  <span class="comment">// Calcul de la moyenne des pressions du sous-domaine.</span></div>
<div class="line">  Real avg_pressure_subdomain = 0;</div>
<div class="line">  <a class="code hl_define" href="../../d6/d0f/ItemEnumerator_8h.html#a44837b340ff8a4fc02299e3160a4da20">ENUMERATE_</a> (Cell, icell, mesh()-&gt;ownCells()) {</div>
<div class="line">    avg_pressure_subdomain += m_pressure[icell];</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> (!mesh()-&gt;ownCells().empty()) {</div>
<div class="line">    avg_pressure_subdomain /= mesh()-&gt;ownCells().size();</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  ISubDomain* sd = subDomain();</div>
<div class="line">  IParallelMng* pm = parallelMng();</div>
<div class="line">  Integer my_rank = pm-&gt;commRank();</div>
<div class="line">  Integer nb_proc = pm-&gt;commSize();</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Calcul de la pression moyenne globale.</span></div>
<div class="line">  Real avg_pressure_global = pm-&gt;reduce(IParallelMng::eReduceType::ReduceSum, avg_pressure_subdomain);</div>
<div class="line">  avg_pressure_global /= nb_proc;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Création de l&#39;objet permettant d&#39;ajouter des valeurs dans un historique des valeurs.</span></div>
<div class="line">  GlobalTimeHistoryAdder global_adder(sd-&gt;timeHistoryMng());</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Ajout de la valeur avg_pressure_subdomain dans l&#39;historique &quot;avg_pressure&quot;. Un historique par sous-domaine.</span></div>
<div class="line">  global_adder.addValue(TimeHistoryAddValueArg(<span class="stringliteral">&quot;avg_pressure&quot;</span>, <span class="keyword">true</span>, my_rank), avg_pressure_subdomain);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Ajout de la valeur avg_pressure_global dans l&#39;historique &quot;avg_pressure&quot;. Historique global.</span></div>
<div class="line">  global_adder.addValue(TimeHistoryAddValueArg(<span class="stringliteral">&quot;avg_pressure&quot;</span>), avg_pressure_global);</div>
<div class="ttc" id="aItemEnumerator_8h_html_a44837b340ff8a4fc02299e3160a4da20"><div class="ttname"><a href="../../d6/d0f/ItemEnumerator_8h.html#a44837b340ff8a4fc02299e3160a4da20">ENUMERATE_</a></div><div class="ttdeci">#define ENUMERATE_(type, name, group)</div><div class="ttdoc">Enumérateur générique d'un groupe d'entité</div><div class="ttdef"><b>Definition</b> <a href="../../d6/d0f/ItemEnumerator_8h_source.html#l00407">ItemEnumerator.h:407</a></div></div>
</div><!-- fragment --><dl class="section remark"><dt>Remarques</dt><dd>En interne, <code>GlobalTimeHistoryAdder</code> utilise la partie interne du <code>ITimeHistoryMng</code> passé en paramètre. L'objet <code>GlobalTimeHistoryAdder</code> peut donc être détruit sans problème.</dd></dl>
<dl class="section note"><dt>Note</dt><dd>Pour utiliser <code>GlobalTimeHistoryAdder</code>, ne pas oublier d'importer les headers nécessaires : <div class="fragment"><div class="line"><span class="preprocessor">#include &lt;arcane/core/ITimeHistoryMng.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;arcane/core/GlobalTimeHistoryAdder.h&gt;</span></div>
</div><!-- fragment --></dd></dl>
<p>Ce bout de code, s'il est appelé à toutes les itérations, permet d'obtenir les moyennes à chaque itération.</p>
<h1><a class="anchor" id="autotoc_md136"></a>
MeshTimeHistoryAdder</h1>
<p>La seconde structure permettant de gérer des historiques de valeurs est le <code>MeshTimeHistoryAdder</code>. Comme la première structure, il permet d'ajouter des valeurs à un historique. Le "Mesh" signifie que les variables internes utilisées pour gérer cet historique sont liées au maillage souhaité. Donc, chaque maillage peut avoir une variable différente de même nom.</p>
<p>Reprenons l'exemple au-dessus mais avec deux maillages. Ces deux maillages sont réparties sur quatre sous-domaines. On veut avoir, pour chaque sous-domaine, la moyenne des pressions des mailles de chaque maillage. Mais on veut toujours, comme au-dessus, la pression moyenne de chaque sous-domaine.</p>
<p>Utilisons la même clef : <code>avg_pressure</code> : </p><div class="image">
<object type="image/svg+xml" data="../../avg_pressure2.svg" style="pointer-events: none;"></object>
</div>
<p>On peut voir qu'en plus des <code>avg_pressure</code> de chaque sous-domaine et du globale, il y a des <code>avg_pressure</code> pour les deux maillages.</p>
<p>Voici un exemple de code pour réaliser ce calcul : </p><div class="fragment"><div class="line">  ISubDomain* sd = subDomain();</div>
<div class="line">  IParallelMng* pm = parallelMng();</div>
<div class="line">  Integer my_rank = pm-&gt;commRank();</div>
<div class="line">  Integer nb_proc = pm-&gt;commSize();</div>
<div class="line">  Integer nb_mesh = sd-&gt;meshes().size();</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Contiendra la moyenne des pressions du sous-domaine (&quot;(2)&quot; sur l&#39;image).</span></div>
<div class="line">  Real avg_pressure_subdomain = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Contiendra la moyenne des pressions de tout le domaine (&quot;(4)&quot; sur l&#39;image)</span></div>
<div class="line">  Real avg_pressure_global = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Pour chaque maillage.</span></div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">auto</span> mesh : sd-&gt;meshes()) {</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Contiendra la moyenne des pressions du sous-domaines et du maillage &quot;mesh&quot; (&quot;(1)&quot; sur l&#39;image).</span></div>
<div class="line">    Real avg_pressure_subdomain_mesh = 0;</div>
<div class="line">    <a class="code hl_define" href="../../d6/d0f/ItemEnumerator_8h.html#a44837b340ff8a4fc02299e3160a4da20">ENUMERATE_</a> (Cell, icell, mesh-&gt;ownCells()) {</div>
<div class="line">      avg_pressure_subdomain_mesh += m_pressure[icell];</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (!mesh-&gt;ownCells().empty()) {</div>
<div class="line">      avg_pressure_subdomain_mesh /= mesh-&gt;ownCells().size();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Contiendra la moyenne des pressions de tout le domaine et du maillage &quot;mesh&quot; (&quot;(3)&quot; sur l&#39;image).</span></div>
<div class="line">    Real avg_pressure_global_mesh = pm-&gt;reduce(IParallelMng::eReduceType::ReduceSum, avg_pressure_subdomain_mesh);</div>
<div class="line">    avg_pressure_global_mesh /= nb_proc;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Création de l&#39;objet permettant d&#39;ajouter des valeurs dans un historique des valeurs lié au maillage &quot;mesh&quot;.</span></div>
<div class="line">    MeshTimeHistoryAdder mesh_adder(sd-&gt;timeHistoryMng(), mesh-&gt;handle());</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Ajout de la valeur avg_pressure_subdomain_mesh dans l&#39;historique &quot;avg_pressure&quot; lié au maillage &quot;mesh&quot;.</span></div>
<div class="line">    <span class="comment">// Un historique par sous-domaine.</span></div>
<div class="line">    mesh_adder.addValue(TimeHistoryAddValueArg(<span class="stringliteral">&quot;avg_pressure&quot;</span>, <span class="keyword">true</span>, my_rank), avg_pressure_subdomain_mesh);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Ajout de la valeur avg_pressure_global dans l&#39;historique &quot;avg_pressure&quot; lié au maillage &quot;mesh&quot;.</span></div>
<div class="line">    <span class="comment">// Historique global.</span></div>
<div class="line">    mesh_adder.addValue(TimeHistoryAddValueArg(<span class="stringliteral">&quot;avg_pressure&quot;</span>), avg_pressure_global_mesh);</div>
<div class="line"> </div>
<div class="line">    avg_pressure_subdomain += avg_pressure_subdomain_mesh;</div>
<div class="line">    avg_pressure_global += avg_pressure_global_mesh;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (nb_mesh != 0) {</div>
<div class="line">    avg_pressure_subdomain /= nb_mesh;</div>
<div class="line">    avg_pressure_global /= nb_mesh;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Création de l&#39;objet permettant d&#39;ajouter des valeurs dans un historique des valeurs.</span></div>
<div class="line">  GlobalTimeHistoryAdder global_adder(sd-&gt;timeHistoryMng());</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Ajout de la valeur avg_pressure_subdomain dans l&#39;historique &quot;avg_pressure&quot;. Un historique par sous-domaine.</span></div>
<div class="line">  global_adder.addValue(TimeHistoryAddValueArg(<span class="stringliteral">&quot;avg_pressure&quot;</span>, <span class="keyword">true</span>, my_rank), avg_pressure_subdomain);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Ajout de la valeur avg_pressure_global dans l&#39;historique &quot;avg_pressure&quot;. Historique global.</span></div>
<div class="line">  global_adder.addValue(TimeHistoryAddValueArg(<span class="stringliteral">&quot;avg_pressure&quot;</span>), avg_pressure_global);</div>
</div><!-- fragment --><p>La différence ici, c'est qu'on itère sur les maillages. Pour créer le <code>MeshTimeHistoryAdder</code>, on doit donner, en plus d'un <code>ITimeHistoryMng*</code>, un handle de maillage. Ça permet de lier l'historique au maillage.</p>
<dl class="section remark"><dt>Remarques</dt><dd>En interne, <code>MeshTimeHistoryAdder</code> utilise la partie interne du <code>ITimeHistoryMng</code> passé en paramètre. L'objet <code>MeshTimeHistoryAdder</code> peut donc être détruit sans problème.</dd></dl>
<dl class="section note"><dt>Note</dt><dd>Pour utiliser <code>MeshTimeHistoryAdder</code>, ne pas oublier d'importer les headers nécessaires : <div class="fragment"><div class="line"><span class="preprocessor">#include &lt;arcane/core/ITimeHistoryMng.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;arcane/core/MeshTimeHistoryAdder.h&gt;</span></div>
</div><!-- fragment --></dd>
<dd>
Le TimeHistoryMng gère les checkpoints, l'utilisateur n'a donc pas à s'en occuper.</dd></dl>
<hr  />
<div class="section_buttons"> <span class="back_section_button"> <a class="el" href="../../d2/db6/arcanedoc_io_timehistory.html">TimeHistory</a> </span> <span class="next_section_button"> <a class="el" href="../../d0/d51/arcanedoc_io_timehistory_results_usage.html">Exploitation des résultats</a> </span> </div> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.5-->
<!-- start footer part -->
  <div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
    <ul>
      <li class="navelem"><a class="el" href="../../index.html">%Arcane</a></li><li class="navelem"><a class="el" href="../../de/d21/arcanedoc_io.html">Entrées / sorties (IO)</a></li><li class="navelem"><a class="el" href="../../d2/db6/arcanedoc_io_timehistory.html">TimeHistory</a></li>
      <li class="footer">Généré le Lundi 15 Juillet 2024 02:42:58 pour Arcane par <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
    </ul>
  </div>
  <script type="text/javascript" src="../../script-apply-config-theme.js"></script>
  <script type="text/javascript">
    // On met l'appel à cette fonction dans le footer dans le cas où
    // une page ne veut pas de personnalisation (changement de la 
    // variable globale "no_custom_theme").
    applyConfigWithCookies();
  </script>
</body>
</html>
